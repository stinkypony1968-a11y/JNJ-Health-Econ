<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ config.territory_name }} â€” Territory Map | J&J MedTech Neurovascular</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --jnj-navy: #00205B;
  --jnj-red: #EB1700;
  --jnj-blue: #0077C8;
  --jnj-dark: #001A47;
  --sidebar-width: 380px;
  --drawer-width: 460px;
  --header-height: 56px;
  --cert-csc: #EB1700;
  --cert-psc: #F59E0B;
  --cert-tsc: #0077C8;
  --cert-none: #6B7280;
  --tier-1: #059669;
  --tier-2: #F59E0B;
  --tier-3: #6B7280;
}
html, body { height: 100%; font-family: 'Inter', -apple-system, sans-serif; background: #f0f2f5; color: #1a1a2e; }
body { display: flex; flex-direction: column; overflow: hidden; }

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  height: var(--header-height); background: var(--jnj-navy);
  display: flex; align-items: center; padding: 0 20px; gap: 16px; z-index: 1000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.header-logo {
  font-size: 13px; font-weight: 700; color: white; letter-spacing: 0.5px;
  display: flex; align-items: center; gap: 8px;
}
.header-logo .jnj-mark {
  width: 28px; height: 28px; background: var(--jnj-red); border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 800; color: white; letter-spacing: 0;
}
.header-territory { font-size: 16px; font-weight: 600; color: white; flex: 1; }
.header-rep { font-size: 12px; color: rgba(255,255,255,0.7); }
.header-rep strong { color: white; font-weight: 600; }
.header-actions { display: flex; gap: 8px; }
.header-btn {
  background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2);
  color: white; padding: 6px 14px; border-radius: 6px; font-size: 12px;
  font-weight: 500; cursor: pointer; transition: all 0.15s; font-family: inherit;
}
.header-btn:hover { background: rgba(255,255,255,0.2); }
.header-btn.active { background: var(--jnj-blue); border-color: var(--jnj-blue); }

/* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main-container { flex: 1; display: flex; position: relative; overflow: hidden; }

/* â”€â”€ Left Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: var(--sidebar-width); background: white; display: flex;
  flex-direction: column; border-right: 1px solid #e2e8f0; z-index: 500;
}
.sidebar-header { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; }
.sidebar-search {
  width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;
  font-size: 13px; font-family: inherit; outline: none; transition: border 0.15s;
}
.sidebar-search:focus { border-color: var(--jnj-blue); }
.sidebar-filters {
  display: flex; gap: 4px; padding: 8px 16px; border-bottom: 1px solid #e2e8f0; flex-wrap: wrap;
}
.filter-btn {
  padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;
  cursor: pointer; border: 1px solid #e2e8f0; background: white; color: #64748b;
  transition: all 0.15s; font-family: inherit;
}
.filter-btn:hover { background: #f8fafc; }
.filter-btn.active { background: var(--jnj-navy); color: white; border-color: var(--jnj-navy); }
.sidebar-sort {
  display: flex; align-items: center; gap: 6px; padding: 6px 16px;
  border-bottom: 1px solid #e2e8f0; font-size: 11px; color: #94a3b8;
}
.sort-select {
  border: none; font-size: 11px; color: var(--jnj-navy); font-weight: 500;
  cursor: pointer; font-family: inherit; outline: none; background: transparent;
}
.sidebar-list { flex: 1; overflow-y: auto; padding: 8px; }
.sidebar-list::-webkit-scrollbar { width: 5px; }
.sidebar-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

/* â”€â”€ Hospital Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hospital-card {
  padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 6px;
  cursor: pointer; transition: all 0.15s; position: relative;
}
.hospital-card:hover { border-color: var(--jnj-blue); box-shadow: 0 2px 8px rgba(0,119,200,0.1); }
.hospital-card.selected { border-color: var(--jnj-blue); background: #f0f7ff; }
.card-header { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
.card-rank {
  width: 22px; height: 22px; border-radius: 50%; background: var(--jnj-navy);
  color: white; font-size: 10px; font-weight: 700; display: flex;
  align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px;
}
.card-name { font-size: 13px; font-weight: 600; color: var(--jnj-navy); flex: 1; line-height: 1.3; }
.card-badges { display: flex; gap: 4px; flex-shrink: 0; }
.badge {
  padding: 2px 7px; border-radius: 4px; font-size: 10px; font-weight: 600;
  letter-spacing: 0.3px; white-space: nowrap;
}
.badge-cert { color: white; }
.badge-tier { color: white; }
.card-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px; color: #64748b; margin-bottom: 6px; padding-left: 30px; }
.card-meta span { display: flex; align-items: center; gap: 3px; }
.card-stats { display: flex; gap: 12px; padding-left: 30px; align-items: center; }
.card-stat-item { font-size: 11px; }
.card-stat-label { color: #94a3b8; }
.card-stat-value { font-weight: 600; color: var(--jnj-navy); }
.card-infra-score {
  margin-left: auto; font-size: 13px; font-weight: 700; padding: 2px 8px;
  border-radius: 4px; background: #f1f5f9;
}

/* â”€â”€ Map Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.map-container { flex: 1; position: relative; }
#map { width: 100%; height: 100%; }
.leaflet-container { background: #dde6ed; }

/* Custom markers */
.hospital-marker {
  border-radius: 50%; border: 2.5px solid white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.15s;
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; color: white; font-family: 'Inter', sans-serif;
}
.hospital-marker:hover { transform: scale(1.2); z-index: 9999 !important; }
.hospital-marker.tier-1 { border-width: 3px; }

/* Map controls */
.map-controls {
  position: absolute; top: 12px; right: 12px; z-index: 500;
  display: flex; flex-direction: column; gap: 6px;
}
.map-ctrl-btn {
  width: 36px; height: 36px; background: white; border: none; border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15); cursor: pointer; display: flex;
  align-items: center; justify-content: center; font-size: 16px;
  transition: all 0.15s; color: var(--jnj-navy);
}
.map-ctrl-btn:hover { background: #f0f7ff; }
.map-ctrl-btn.active { background: var(--jnj-blue); color: white; }

/* â”€â”€ Right Drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.drawer {
  width: var(--drawer-width); background: white; position: absolute;
  top: 0; right: 0; height: 100%; z-index: 600;
  transform: translateX(100%); transition: transform 0.3s ease;
  box-shadow: -4px 0 16px rgba(0,0,0,0.1); display: flex; flex-direction: column;
  overflow: hidden;
}
.drawer.open { transform: translateX(0); }
.drawer-header {
  padding: 14px 16px; background: var(--jnj-navy); color: white;
  display: flex; align-items: center; justify-content: space-between;
}
.drawer-title { font-size: 14px; font-weight: 600; }
.drawer-close {
  width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.15);
  border: none; color: white; font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.drawer-body { flex: 1; overflow-y: auto; padding: 16px; }
.drawer-body::-webkit-scrollbar { width: 5px; }
.drawer-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

/* Drawer sections */
.drawer-section { margin-bottom: 20px; }
.drawer-section-title {
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px;
  color: #94a3b8; margin-bottom: 10px; padding-bottom: 6px;
  border-bottom: 1px solid #f1f5f9;
}
.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.detail-item { }
.detail-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
.detail-value { font-size: 13px; font-weight: 600; color: var(--jnj-navy); }

/* Infrastructure gauge */
.infra-gauge-container { display: flex; align-items: center; gap: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; }
.infra-gauge {
  width: 64px; height: 64px; border-radius: 50%; position: relative;
  display: flex; align-items: center; justify-content: center;
}
.infra-gauge-value { font-size: 20px; font-weight: 800; }
.infra-gauge-info { flex: 1; }
.infra-tier-badge {
  display: inline-block; padding: 3px 10px; border-radius: 4px;
  font-size: 11px; font-weight: 700; color: white; margin-bottom: 4px;
}
.infra-tier-desc { font-size: 12px; color: #64748b; }

/* Infrastructure checklist */
.infra-checklist { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.infra-check-item {
  display: flex; align-items: center; gap: 8px; padding: 6px 10px;
  background: #f8fafc; border-radius: 6px; font-size: 12px;
}
.infra-check-icon { font-size: 14px; flex-shrink: 0; }
.infra-check-icon.yes { color: #059669; }
.infra-check-icon.no { color: #dc2626; opacity: 0.4; }
.infra-check-label { color: #475569; font-weight: 500; }

/* Prevalence bars */
.prev-bar-container { margin-bottom: 8px; }
.prev-bar-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; }
.prev-bar-name { color: #64748b; }
.prev-bar-val { font-weight: 600; color: var(--jnj-navy); }
.prev-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
.prev-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

/* Epi summary cards */
.epi-summary { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
.epi-card {
  text-align: center; padding: 10px 6px; background: #f8fafc; border-radius: 8px;
  border: 1px solid #e2e8f0;
}
.epi-card-value { font-size: 18px; font-weight: 800; color: var(--jnj-navy); }
.epi-card-label { font-size: 9px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

/* Geographic access badge */
.geo-access-badge {
  display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px;
  border-radius: 6px; font-size: 12px; font-weight: 600; margin-bottom: 8px;
}
.geo-access-badge.local { background: #ecfdf5; color: #059669; }
.geo-access-badge.short { background: #eff6ff; color: #2563eb; }
.geo-access-badge.long { background: #fffbeb; color: #d97706; }
.geo-access-badge.flight { background: #fef2f2; color: #dc2626; }

/* â”€â”€ Choropleth Legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.choropleth-legend {
  position: absolute; bottom: 20px; left: 12px; z-index: 500;
  background: white; border-radius: 8px; padding: 10px 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-family: 'Inter', sans-serif;
  display: none;
}
.legend-title {
  font-size: 11px; font-weight: 700; color: var(--jnj-navy);
  margin-bottom: 8px; line-height: 1.3;
}
.legend-items { display: flex; flex-direction: column; gap: 3px; }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 10px; color: #475569; }
.legend-color { width: 18px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }
.legend-source { font-size: 9px; color: #94a3b8; margin-top: 6px; font-style: italic; }

/* County tooltip */
.county-tooltip {
  font-family: 'Inter', sans-serif !important;
  font-size: 12px !important;
  padding: 6px 10px !important;
  border-radius: 6px !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
}
.county-tooltip .county-name { font-weight: 700; color: var(--jnj-navy); }
.county-tooltip .county-rate { font-weight: 600; }

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast-container {
  position: fixed; bottom: 20px; right: 20px; z-index: 9999;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  padding: 10px 16px; border-radius: 8px; background: var(--jnj-navy);
  color: white; font-size: 12px; font-weight: 500;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(10px);
  transition: all 0.3s ease; max-width: 300px;
}
.toast.show { opacity: 1; transform: translateY(0); }

/* â”€â”€ Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.leaflet-popup-content-wrapper {
  border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); padding: 0;
}
.leaflet-popup-content { margin: 0; min-width: 240px; }
.popup-inner { padding: 14px; }
.popup-name { font-size: 14px; font-weight: 700; color: var(--jnj-navy); margin-bottom: 4px; }
.popup-cert { font-size: 11px; margin-bottom: 8px; }
.popup-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.popup-stat-label { font-size: 10px; color: #94a3b8; }
.popup-stat-value { font-size: 13px; font-weight: 600; color: var(--jnj-navy); }
.popup-btn {
  display: block; width: 100%; padding: 8px; background: var(--jnj-navy);
  color: white; border: none; border-radius: 6px; font-size: 12px;
  font-weight: 600; cursor: pointer; margin-top: 10px; font-family: inherit;
  transition: background 0.15s;
}
.popup-btn:hover { background: var(--jnj-blue); }

/* â”€â”€ Source Tooltips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.src-tip {
  display: inline-flex; align-items: center; justify-content: center;
  width: 14px; height: 14px; border-radius: 50%;
  background: #e2e8f0; color: #64748b; font-size: 9px; font-weight: 700;
  cursor: help; position: relative; vertical-align: middle; margin-left: 3px;
  font-style: italic; font-family: Georgia, serif; line-height: 1;
}
.src-tip:hover { background: var(--jnj-blue); color: white; }
.src-tip:hover::after {
  content: attr(data-src);
  position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%);
  background: var(--jnj-navy); color: white; padding: 6px 10px;
  border-radius: 6px; font-size: 10px; font-weight: 400; font-style: normal;
  font-family: 'Inter', sans-serif; white-space: nowrap; z-index: 9999;
  max-width: 340px; white-space: normal; line-height: 1.4;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3); pointer-events: none;
}
.src-tip:hover::before {
  content: ''; position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%);
  border: 5px solid transparent; border-top-color: var(--jnj-navy); z-index: 9999;
}

/* Sources panel â€” collapsible */
.sources-panel {
  padding: 0; background: #f8fafc; border-radius: 8px;
  border: 1px solid #e2e8f0; margin-top: 8px; overflow: hidden;
}
.sources-toggle {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 12px; cursor: pointer; user-select: none;
  background: #f8fafc; border: none; width: 100%; text-align: left;
  font-family: inherit; transition: background 0.15s;
}
.sources-toggle:hover { background: #eef2f7; }
.sources-panel-title {
  font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase;
  letter-spacing: 0.8px; margin: 0;
}
.sources-chevron {
  font-size: 12px; color: #94a3b8; transition: transform 0.25s ease;
}
.sources-chevron.open { transform: rotate(180deg); }
.sources-body {
  max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
  padding: 0 12px;
}
.sources-body.open { max-height: 600px; padding: 0 12px 12px; }
.sources-panel-item {
  font-size: 10px; color: #64748b; line-height: 1.6; margin-bottom: 4px;
  padding-left: 12px; text-indent: -12px;
}
.sources-panel-item strong { color: var(--jnj-navy); }

/* â”€â”€ County Flyaway Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.county-flyaway {
  position: absolute; z-index: 900;
  background: white; border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.18), 0 2px 8px rgba(0,0,0,0.08);
  width: 340px; font-family: 'Inter', sans-serif;
  pointer-events: auto; opacity: 0; transform: translateY(8px) scale(0.96);
  transition: opacity 0.25s ease, transform 0.25s ease;
  overflow: hidden;
}
.county-flyaway.visible { opacity: 1; transform: translateY(0) scale(1); }
.county-flyaway-header {
  padding: 12px 14px; display: flex; align-items: center; justify-content: space-between;
  border-bottom: 1px solid #e2e8f0;
}
.county-flyaway-header-left { display: flex; align-items: center; gap: 8px; }
.county-flyaway-name { font-size: 14px; font-weight: 700; color: var(--jnj-navy); }
.county-flyaway-state { font-size: 10px; color: #94a3b8; font-weight: 500; }
.county-flyaway-badge {
  padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; color: white;
}
.county-flyaway-close {
  width: 24px; height: 24px; border-radius: 50%; background: #f1f5f9;
  border: none; color: #64748b; font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  transition: background 0.15s;
}
.county-flyaway-close:hover { background: #e2e8f0; }
.county-flyaway-body { padding: 12px 14px; }
.county-flyaway-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
.county-flyaway-card {
  padding: 8px 10px; border-radius: 8px; border: 1px solid #e2e8f0;
}
.county-flyaway-card-label { font-size: 9px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
.county-flyaway-card-value { font-size: 18px; font-weight: 800; margin-top: 2px; }
.county-flyaway-card-sub { font-size: 9px; color: #94a3b8; margin-top: 1px; }
.county-flyaway-card.afib { background: #fef2f2; border-color: #fecaca; }
.county-flyaway-card.afib .county-flyaway-card-value { color: #DC2626; }
.county-flyaway-card.mortality { background: #fff7ed; border-color: #fed7aa; }
.county-flyaway-card.mortality .county-flyaway-card-value { color: #EA580C; }
.county-flyaway-card.anticoag { background: #eff6ff; border-color: #bfdbfe; }
.county-flyaway-card.anticoag .county-flyaway-card-value { color: #2563EB; }
.county-flyaway-card.glp1 { background: #faf5ff; border-color: #e9d5ff; }
.county-flyaway-card.glp1 .county-flyaway-card-value { color: #7C3AED; }
.county-flyaway-bars { display: flex; flex-direction: column; gap: 6px; margin-top: 8px; }
.county-flyaway-bar-row { display: flex; align-items: center; gap: 8px; font-size: 11px; }
.county-flyaway-bar-label { width: 62px; color: #64748b; font-weight: 500; flex-shrink: 0; }
.county-flyaway-bar-track { flex: 1; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
.county-flyaway-bar-fill { height: 100%; border-radius: 4px; transition: width 0.4s ease; }
.county-flyaway-bar-val { width: 40px; text-align: right; font-weight: 600; color: var(--jnj-navy); }
.county-flyaway-footer {
  padding: 8px 14px; background: #f8fafc; border-top: 1px solid #e2e8f0;
  display: flex; align-items: center; gap: 6px;
  font-size: 9px; color: #94a3b8;
}

/* GLP-1 section */
.glp1-cards { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }
.glp1-card {
  text-align: center; padding: 10px 6px; background: #faf5ff; border-radius: 8px;
  border: 1px solid #e9d5ff;
}
.glp1-card-value { font-size: 17px; font-weight: 800; color: #7C3AED; }
.glp1-card-label { font-size: 9px; color: #a78bfa; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1200px) {
  :root { --sidebar-width: 320px; --drawer-width: 400px; }
}
@media (max-width: 1024px) {
  :root { --sidebar-width: 280px; --drawer-width: 100%; }
  .header-rep { display: none; }
}
</style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="header">
  <div class="header-logo">
    <div class="jnj-mark">J&J</div>
    MEDTECH NEUROVASCULAR
  </div>
  <div class="header-territory">{{ config.territory_name }}</div>
  <div class="header-rep"><strong>{{ config.rep_name }}</strong> Â· {{ config.rep_role }}{% if config.rep_base_city %} Â· {{ config.rep_base_city }}{% endif %}</div>
  <div class="header-actions">
    <button class="header-btn" id="btnFitAll" title="Fit All Markers">âŠž Fit All</button>
    <button class="header-btn" id="btnChoropleth" title="Toggle CDC Stroke Mortality Overlay">ðŸ”¬ Mortality</button>
  </div>
</div>

<!-- â”€â”€ Main Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="main-container">

  <!-- Left Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <input type="text" class="sidebar-search" id="searchInput" placeholder="Search hospitals..." />
    </div>
    <div class="sidebar-filters" id="filterBar">
      <button class="filter-btn active" data-filter="all">All ({{ hospital_count }})</button>
      {% if cert_counts.CSC > 0 %}<button class="filter-btn" data-filter="CSC">CSC ({{ cert_counts.CSC }})</button>{% endif %}
      {% if cert_counts.PSC > 0 %}<button class="filter-btn" data-filter="PSC">PSC ({{ cert_counts.PSC }})</button>{% endif %}
      {% if cert_counts.TSC > 0 or cert_counts.TCC > 0 %}<button class="filter-btn" data-filter="TSC">TSC ({{ cert_counts.TSC + cert_counts.TCC }})</button>{% endif %}
      {% if cert_counts.None > 0 %}<button class="filter-btn" data-filter="None">None ({{ cert_counts.None }})</button>{% endif %}
    </div>
    <div class="sidebar-sort">
      Sort by:
      <select class="sort-select" id="sortSelect">
        <option value="infrastructure_score">Infra Score â†“</option>
        <option value="strokes_yr">Strokes/Yr â†“</option>
        <option value="lvo_volume">LVO Volume â†“</option>
        <option value="beds">Beds â†“</option>
        <option value="name">Name A-Z</option>
      </select>
    </div>
    <div class="sidebar-list" id="hospitalList"></div>
  </div>

  <!-- Map -->
  <div class="map-container">
    <div id="map"></div>
    <div class="map-controls">
      <button class="map-ctrl-btn" id="btnZoomIn" title="Zoom In">+</button>
      <button class="map-ctrl-btn" id="btnZoomOut" title="Zoom Out">âˆ’</button>
    </div>

    <!-- Choropleth Legend -->
    <div class="choropleth-legend" id="choroplethLegend">
      <div class="legend-title">Stroke Mortality Rate<br><span style="font-weight:400;font-size:10px;color:#64748b;">per 100k, age-adjusted (ICD-10 I60-I69)</span></div>
      <div class="legend-items">
        <div class="legend-item"><span class="legend-color" style="background:#ffffb2;"></span>&lt; 30</div>
        <div class="legend-item"><span class="legend-color" style="background:#fed976;"></span>30 â€“ 38</div>
        <div class="legend-item"><span class="legend-color" style="background:#feb24c;"></span>38 â€“ 44</div>
        <div class="legend-item"><span class="legend-color" style="background:#fd8d3c;"></span>44 â€“ 50</div>
        <div class="legend-item"><span class="legend-color" style="background:#fc4e2a;"></span>50 â€“ 58</div>
        <div class="legend-item"><span class="legend-color" style="background:#e31a1c;"></span>58 â€“ 68</div>
        <div class="legend-item"><span class="legend-color" style="background:#b10026;"></span>&gt; 68</div>
      </div>
      <div class="legend-source">Source: CDC WONDER Compressed Mortality 2018-2022<br>Age-adjusted to 2000 U.S. standard population</div>
    </div>

    <!-- County Flyaway Card -->
    <div class="county-flyaway" id="countyFlyaway"></div>

    <!-- Right Drawer (Account Detail) -->
    <div class="drawer" id="accountDrawer">
      <div class="drawer-header">
        <span class="drawer-title" id="drawerTitle">Account Detail</span>
        <button class="drawer-close" id="drawerClose">âœ•</button>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<!-- â”€â”€ JavaScript â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
// â”€â”€ Data â”€â”€
const HOSPITALS = {{ hospitals_json }};
const CONFIG = {
  repName: "{{ config.rep_name }}",
  repRole: "{{ config.rep_role }}",
  repBaseCity: "{{ config.rep_base_city }}",
  repBaseLat: {{ config.rep_base_lat }},
  repBaseLng: {{ config.rep_base_lng }},
  territoryName: "{{ config.territory_name }}",
  mapCenterLat: {{ config.map_center_lat }},
  mapCenterLng: {{ config.map_center_lng }},
  mapZoom: {{ config.map_zoom }},
  teamMembers: {{ config.team_members | tojson }}
};

// â”€â”€ County Data: CDC WONDER Stroke Mortality + A-Fib Epidemiology â”€â”€
// Fields: n=name, r=stroke mortality/100k (ICD-10 I60-I69, age-adjusted 2018-2022),
//   a=A-Fib prevalence %, ac=anticoag use %, ob=obesity %, db=diabetes %,
//   g=GLP-1 prescribing index (0-100), p=pop in thousands, u=urban(1)/rural(0)
// Sources: CDC WONDER Compressed Mortality Â· CMS Chronic Conditions Warehouse Â·
//   BRFSS Â· CMS Medicare Part D PUF Â· US Census ACS
const COUNTY_DATA = {
  // â”€â”€ Florida (67 counties) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "12001":{n:"Alachua",r:38.2,a:4.8,ac:68,ob:28.4,db:10.2,g:62,p:284,u:1},
  "12003":{n:"Baker",r:55.3,a:4.6,ac:58,ob:35.2,db:13.8,g:38,p:28,u:0},
  "12005":{n:"Bay",r:44.8,a:5.1,ac:64,ob:31.6,db:11.9,g:48,p:185,u:1},
  "12007":{n:"Bradford",r:52.1,a:4.9,ac:59,ob:34.1,db:13.2,g:42,p:27,u:0},
  "12009":{n:"Brevard",r:37.6,a:5.9,ac:71,ob:27.8,db:10.6,g:58,p:621,u:1},
  "12011":{n:"Broward",r:31.4,a:5.3,ac:76,ob:25.4,db:9.7,g:78,p:2000,u:1},
  "12013":{n:"Calhoun",r:58.7,a:5.2,ac:56,ob:38.9,db:14.6,g:35,p:14,u:0},
  "12015":{n:"Charlotte",r:36.8,a:6.8,ac:73,ob:28.2,db:10.8,g:71,p:180,u:1},
  "12017":{n:"Citrus",r:42.3,a:6.4,ac:69,ob:32.1,db:12.1,g:52,p:140,u:0},
  "12019":{n:"Clay",r:39.5,a:5.4,ac:70,ob:28.6,db:10.7,g:65,p:215,u:1},
  "12021":{n:"Collier",r:29.8,a:6.2,ac:77,ob:26.3,db:9.4,g:82,p:380,u:1},
  "12023":{n:"Columbia",r:48.6,a:5.1,ac:61,ob:33.7,db:12.8,g:45,p:68,u:0},
  "12027":{n:"DeSoto",r:51.4,a:5.0,ac:60,ob:34.8,db:13.1,g:40,p:35,u:0},
  "12029":{n:"Dixie",r:57.8,a:5.3,ac:57,ob:36.2,db:13.9,g:38,p:16,u:0},
  "12031":{n:"Duval",r:43.1,a:5.2,ac:67,ob:30.2,db:11.5,g:62,p:1000,u:1},
  "12033":{n:"Escambia",r:46.2,a:5.0,ac:63,ob:31.8,db:12.1,g:54,p:323,u:1},
  "12035":{n:"Flagler",r:35.9,a:5.7,ac:72,ob:27.6,db:10.3,g:68,p:115,u:1},
  "12037":{n:"Franklin",r:54.2,a:4.8,ac:55,ob:35.6,db:13.4,g:36,p:12,u:0},
  "12039":{n:"Gadsden",r:62.8,a:5.4,ac:58,ob:39.1,db:14.9,g:32,p:47,u:0},
  "12041":{n:"Gilchrist",r:53.1,a:5.1,ac:58,ob:35.4,db:13.6,g:39,p:18,u:0},
  "12043":{n:"Glades",r:56.4,a:4.9,ac:56,ob:36.8,db:13.9,g:34,p:12,u:0},
  "12045":{n:"Gulf",r:52.7,a:5.2,ac:58,ob:35.9,db:13.7,g:37,p:14,u:0},
  "12047":{n:"Hamilton",r:61.5,a:5.0,ac:57,ob:38.2,db:14.6,g:33,p:15,u:0},
  "12049":{n:"Hardee",r:50.3,a:4.8,ac:59,ob:34.6,db:13.2,g:41,p:28,u:0},
  "12051":{n:"Hendry",r:48.9,a:4.9,ac:61,ob:33.2,db:12.6,g:43,p:40,u:0},
  "12053":{n:"Hernando",r:41.7,a:6.3,ac:70,ob:31.4,db:11.9,g:59,p:184,u:0},
  "12055":{n:"Highlands",r:44.6,a:5.8,ac:68,ob:30.7,db:11.6,g:56,p:102,u:0},
  "12057":{n:"Hillsborough",r:36.4,a:5.1,ac:71,ob:27.9,db:10.5,g:72,p:1500,u:1},
  "12059":{n:"Holmes",r:55.8,a:4.7,ac:57,ob:36.1,db:13.8,g:37,p:19,u:0},
  "12061":{n:"Indian River",r:34.2,a:6.1,ac:74,ob:26.8,db:9.9,g:75,p:159,u:1},
  "12063":{n:"Jackson",r:54.6,a:5.0,ac:59,ob:35.8,db:13.7,g:39,p:49,u:0},
  "12065":{n:"Jefferson",r:59.3,a:5.1,ac:57,ob:37.4,db:14.3,g:34,p:14,u:0},
  "12067":{n:"Lafayette",r:57.2,a:4.9,ac:56,ob:36.5,db:13.9,g:35,p:9,u:0},
  "12069":{n:"Lake",r:38.1,a:5.9,ac:69,ob:29.3,db:11.1,g:61,p:365,u:1},
  "12071":{n:"Lee",r:33.5,a:6.0,ac:75,ob:26.1,db:9.3,g:79,p:673,u:1},
  "12073":{n:"Leon",r:39.8,a:4.9,ac:66,ob:29.4,db:10.8,g:68,p:287,u:1},
  "12075":{n:"Levy",r:50.7,a:5.2,ac:59,ob:35.1,db:13.4,g:40,p:41,u:0},
  "12077":{n:"Liberty",r:60.1,a:5.0,ac:56,ob:37.8,db:14.5,g:32,p:8,u:0},
  "12079":{n:"Madison",r:58.6,a:5.1,ac:58,ob:36.9,db:14.1,g:36,p:19,u:0},
  "12081":{n:"Manatee",r:35.8,a:5.9,ac:72,ob:28.4,db:10.7,g:73,p:422,u:1},
  "12083":{n:"Marion",r:42.4,a:5.6,ac:66,ob:31.8,db:12.3,g:54,p:378,u:0},
  "12085":{n:"Martin",r:32.1,a:6.3,ac:76,ob:25.6,db:9.2,g:81,p:160,u:1},
  "12086":{n:"Miami-Dade",r:28.7,a:5.2,ac:77,ob:24.8,db:9.1,g:82,p:2800,u:1},
  "12087":{n:"Monroe",r:33.4,a:5.8,ac:73,ob:26.2,db:9.5,g:76,p:73,u:1},
  "12089":{n:"Nassau",r:40.6,a:4.9,ac:64,ob:30.8,db:11.7,g:56,p:80,u:0},
  "12091":{n:"Okaloosa",r:38.9,a:5.0,ac:65,ob:29.6,db:11.2,g:59,p:202,u:1},
  "12093":{n:"Okeechobee",r:49.2,a:5.1,ac:61,ob:32.9,db:12.5,g:46,p:42,u:0},
  "12095":{n:"Orange",r:32.8,a:5.0,ac:72,ob:27.1,db:10.2,g:75,p:1450,u:1},
  "12097":{n:"Osceola",r:35.4,a:4.8,ac:70,ob:28.3,db:10.6,g:70,p:408,u:1},
  "12099":{n:"Palm Beach",r:30.2,a:6.1,ac:76,ob:26.0,db:9.4,g:80,p:1500,u:1},
  "12101":{n:"Pasco",r:40.1,a:6.2,ac:70,ob:30.6,db:11.7,g:64,p:530,u:1},
  "12103":{n:"Pinellas",r:35.7,a:6.4,ac:73,ob:27.4,db:10.4,g:74,p:960,u:1},
  "12105":{n:"Polk",r:41.9,a:5.5,ac:68,ob:31.2,db:11.8,g:60,p:724,u:1},
  "12107":{n:"Putnam",r:54.8,a:5.3,ac:60,ob:34.3,db:13.1,g:44,p:74,u:0},
  "12109":{n:"St. Johns",r:29.6,a:5.1,ac:73,ob:26.7,db:9.8,g:77,p:235,u:1},
  "12111":{n:"St. Lucie",r:37.3,a:5.9,ac:71,ob:28.9,db:10.9,g:70,p:319,u:1},
  "12113":{n:"Santa Rosa",r:41.2,a:5.0,ac:66,ob:30.4,db:11.6,g:60,p:196,u:1},
  "12115":{n:"Sarasota",r:31.6,a:6.7,ac:74,ob:26.4,db:9.6,g:79,p:429,u:1},
  "12117":{n:"Seminole",r:33.2,a:5.1,ac:72,ob:27.2,db:10.1,g:76,p:490,u:1},
  "12119":{n:"Sumter",r:36.5,a:7.2,ac:72,ob:29.1,db:11.3,g:66,p:118,u:0},
  "12121":{n:"Suwannee",r:52.4,a:5.0,ac:59,ob:34.8,db:13.3,g:41,p:42,u:0},
  "12123":{n:"Taylor",r:56.1,a:5.2,ac:58,ob:35.7,db:13.6,g:38,p:22,u:0},
  "12125":{n:"Union",r:53.7,a:4.9,ac:57,ob:35.6,db:13.5,g:39,p:16,u:0},
  "12127":{n:"Volusia",r:39.4,a:5.8,ac:69,ob:29.6,db:11.3,g:63,p:544,u:1},
  "12129":{n:"Wakulla",r:47.8,a:5.1,ac:62,ob:32.8,db:12.4,g:48,p:35,u:0},
  "12131":{n:"Walton",r:43.5,a:5.0,ac:63,ob:31.4,db:12.0,g:51,p:64,u:0},
  "12133":{n:"Washington",r:55.2,a:5.0,ac:58,ob:35.9,db:13.8,g:38,p:24,u:0},
  // â”€â”€ Georgia (159 counties) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "13001":{n:"Appling",r:56.3,a:5.1,ac:58,ob:36.4,db:13.9,g:38,p:19,u:0},
  "13003":{n:"Atkinson",r:58.1,a:5.0,ac:57,ob:37.2,db:14.2,g:36,p:8,u:0},
  "13005":{n:"Bacon",r:55.7,a:5.1,ac:59,ob:35.8,db:13.6,g:39,p:12,u:0},
  "13007":{n:"Baker",r:67.2,a:5.3,ac:56,ob:39.6,db:14.9,g:32,p:4,u:0},
  "13009":{n:"Baldwin",r:52.8,a:5.2,ac:60,ob:34.1,db:13.0,g:43,p:45,u:0},
  "13011":{n:"Banks",r:48.6,a:4.8,ac:62,ob:32.3,db:12.3,g:49,p:18,u:0},
  "13013":{n:"Barrow",r:44.1,a:4.9,ac:64,ob:30.7,db:11.7,g:54,p:75,u:0},
  "13015":{n:"Bartow",r:46.3,a:5.0,ac:63,ob:31.9,db:12.1,g:52,p:107,u:0},
  "13017":{n:"Ben Hill",r:61.4,a:5.3,ac:57,ob:38.3,db:14.5,g:34,p:17,u:0},
  "13019":{n:"Berrien",r:54.7,a:5.2,ac:59,ob:35.6,db:13.5,g:39,p:20,u:0},
  "13021":{n:"Bibb",r:58.9,a:5.2,ac:59,ob:37.1,db:14.1,g:38,p:151,u:1},
  "13023":{n:"Bleckley",r:53.2,a:5.1,ac:59,ob:35.2,db:13.3,g:40,p:13,u:0},
  "13025":{n:"Brantley",r:52.8,a:5.1,ac:59,ob:35.4,db:13.4,g:39,p:18,u:0},
  "13027":{n:"Brooks",r:57.6,a:5.2,ac:58,ob:36.8,db:14.0,g:37,p:3,u:0},
  "13029":{n:"Bryan",r:41.3,a:5.0,ac:65,ob:30.4,db:11.5,g:56,p:38,u:0},
  "13031":{n:"Bulloch",r:48.4,a:4.9,ac:62,ob:32.1,db:12.2,g:51,p:81,u:0},
  "13033":{n:"Burke",r:63.1,a:5.3,ac:57,ob:38.9,db:14.7,g:33,p:23,u:0},
  "13035":{n:"Butts",r:50.6,a:5.1,ac:60,ob:33.8,db:12.9,g:45,p:24,u:0},
  "13037":{n:"Calhoun",r:68.4,a:5.4,ac:56,ob:40.2,db:15.1,g:31,p:6,u:0},
  "13039":{n:"Camden",r:44.7,a:5.0,ac:64,ob:31.2,db:11.8,g:53,p:55,u:0},
  "13043":{n:"Candler",r:56.8,a:5.2,ac:59,ob:36.1,db:13.7,g:38,p:11,u:0},
  "13045":{n:"Carroll",r:47.2,a:5.0,ac:62,ob:32.6,db:12.4,g:50,p:115,u:0},
  "13047":{n:"Catoosa",r:43.8,a:5.0,ac:64,ob:30.8,db:11.7,g:55,p:70,u:0},
  "13049":{n:"Charlton",r:54.3,a:5.1,ac:59,ob:35.9,db:13.6,g:39,p:12,u:0},
  "13051":{n:"Chatham",r:48.6,a:5.1,ac:66,ob:32.4,db:12.3,g:61,p:295,u:1},
  "13053":{n:"Chattahoochee",r:52.1,a:5.2,ac:60,ob:34.7,db:13.2,g:44,p:16,u:0},
  "13055":{n:"Chattooga",r:55.4,a:5.1,ac:59,ob:35.7,db:13.6,g:39,p:25,u:0},
  "13057":{n:"Cherokee",r:38.7,a:4.9,ac:68,ob:28.9,db:10.9,g:67,p:291,u:1},
  "13059":{n:"Clarke",r:42.3,a:4.8,ac:66,ob:30.2,db:11.4,g:63,p:127,u:1},
  "13061":{n:"Clay",r:69.7,a:5.4,ac:55,ob:40.6,db:15.2,g:30,p:3,u:0},
  "13063":{n:"Clayton",r:47.8,a:5.0,ac:62,ob:32.8,db:12.5,g:51,p:318,u:1},
  "13065":{n:"Clinch",r:58.6,a:5.2,ac:58,ob:36.7,db:13.9,g:37,p:7,u:0},
  "13067":{n:"Cobb",r:36.4,a:4.9,ac:72,ob:26.4,db:9.8,g:76,p:770,u:1},
  "13069":{n:"Coffee",r:55.1,a:5.1,ac:59,ob:35.6,db:13.5,g:40,p:42,u:0},
  "13071":{n:"Colquitt",r:54.8,a:5.1,ac:59,ob:35.4,db:13.4,g:40,p:46,u:0},
  "13073":{n:"Columbia",r:39.2,a:5.0,ac:69,ob:29.1,db:11.0,g:65,p:143,u:1},
  "13075":{n:"Cook",r:56.3,a:5.2,ac:59,ob:35.8,db:13.6,g:39,p:18,u:0},
  "13077":{n:"Coweta",r:42.7,a:5.0,ac:65,ob:31.1,db:11.8,g:58,p:145,u:1},
  "13079":{n:"Crawford",r:54.8,a:5.1,ac:59,ob:35.6,db:13.5,g:40,p:12,u:0},
  "13081":{n:"Crisp",r:61.7,a:5.3,ac:58,ob:37.8,db:14.3,g:35,p:24,u:0},
  "13083":{n:"Dade",r:46.2,a:5.0,ac:63,ob:31.6,db:12.0,g:52,p:17,u:0},
  "13085":{n:"Dawson",r:41.5,a:4.9,ac:65,ob:30.3,db:11.5,g:57,p:23,u:0},
  "13087":{n:"Decatur",r:64.3,a:5.3,ac:57,ob:38.6,db:14.6,g:33,p:28,u:0},
  "13089":{n:"DeKalb",r:43.1,a:5.0,ac:70,ob:29.3,db:11.1,g:72,p:760,u:1},
  "13091":{n:"Dodge",r:57.4,a:5.2,ac:58,ob:36.2,db:13.8,g:38,p:20,u:0},
  "13093":{n:"Dooly",r:65.8,a:5.3,ac:57,ob:39.1,db:14.8,g:32,p:11,u:0},
  "13095":{n:"Dougherty",r:62.5,a:5.3,ac:58,ob:38.4,db:14.5,g:34,p:94,u:0},
  "13097":{n:"Douglas",r:44.6,a:5.0,ac:63,ob:31.4,db:11.9,g:53,p:145,u:1},
  "13099":{n:"Early",r:66.1,a:5.3,ac:56,ob:39.3,db:14.9,g:31,p:11,u:0},
  "13101":{n:"Echols",r:57.9,a:5.2,ac:58,ob:36.5,db:13.8,g:37,p:4,u:0},
  "13103":{n:"Effingham",r:43.2,a:5.0,ac:65,ob:30.7,db:11.6,g:56,p:68,u:0},
  "13105":{n:"Elbert",r:53.7,a:5.1,ac:60,ob:34.9,db:13.2,g:43,p:21,u:0},
  "13107":{n:"Emanuel",r:58.2,a:5.2,ac:58,ob:36.6,db:13.9,g:37,p:28,u:0},
  "13109":{n:"Evans",r:55.6,a:5.1,ac:59,ob:35.7,db:13.6,g:39,p:11,u:0},
  "13111":{n:"Fannin",r:45.8,a:5.0,ac:62,ob:32.4,db:12.3,g:50,p:25,u:0},
  "13113":{n:"Fayette",r:35.4,a:4.9,ac:71,ob:27.3,db:10.2,g:74,p:135,u:1},
  "13115":{n:"Floyd",r:49.3,a:5.0,ac:61,ob:33.2,db:12.6,g:47,p:97,u:0},
  "13117":{n:"Forsyth",r:33.8,a:4.8,ac:72,ob:26.8,db:9.9,g:77,p:252,u:1},
  "13119":{n:"Franklin",r:50.1,a:5.1,ac:60,ob:33.9,db:12.9,g:45,p:23,u:0},
  "13121":{n:"Fulton",r:41.2,a:5.0,ac:70,ob:29.6,db:11.2,g:71,p:1100,u:1},
  "13123":{n:"Gilmer",r:44.6,a:5.0,ac:62,ob:31.8,db:12.1,g:51,p:31,u:0},
  "13125":{n:"Glascock",r:56.4,a:5.2,ac:59,ob:35.9,db:13.6,g:38,p:3,u:0},
  "13127":{n:"Glynn",r:47.3,a:5.1,ac:63,ob:32.6,db:12.4,g:54,p:84,u:1},
  "13129":{n:"Gordon",r:47.8,a:5.0,ac:61,ob:33.1,db:12.6,g:47,p:56,u:0},
  "13131":{n:"Grady",r:58.9,a:5.2,ac:58,ob:37.3,db:14.2,g:37,p:25,u:0},
  "13133":{n:"Greene",r:51.6,a:5.1,ac:60,ob:34.2,db:13.0,g:44,p:18,u:0},
  "13135":{n:"Gwinnett",r:34.7,a:4.8,ac:71,ob:26.9,db:10.0,g:77,p:960,u:1},
  "13137":{n:"Habersham",r:46.1,a:5.0,ac:62,ob:31.9,db:12.1,g:51,p:45,u:0},
  "13139":{n:"Hall",r:41.8,a:5.0,ac:66,ob:30.4,db:11.5,g:60,p:222,u:1},
  "13141":{n:"Hancock",r:67.4,a:5.3,ac:56,ob:39.8,db:15.0,g:31,p:9,u:0},
  "13143":{n:"Haralson",r:49.7,a:5.0,ac:61,ob:33.3,db:12.7,g:46,p:29,u:0},
  "13145":{n:"Harris",r:44.3,a:5.0,ac:63,ob:31.2,db:11.8,g:53,p:33,u:0},
  "13147":{n:"Hart",r:51.2,a:5.1,ac:60,ob:34.1,db:13.0,g:44,p:26,u:0},
  "13149":{n:"Heard",r:50.8,a:5.0,ac:60,ob:33.6,db:12.8,g:45,p:11,u:0},
  "13151":{n:"Henry",r:42.1,a:4.9,ac:67,ob:29.8,db:11.3,g:63,p:246,u:1},
  "13153":{n:"Houston",r:47.6,a:5.0,ac:63,ob:32.3,db:12.2,g:54,p:155,u:1},
  "13155":{n:"Irwin",r:58.7,a:5.2,ac:58,ob:37.1,db:14.1,g:37,p:9,u:0},
  "13157":{n:"Jackson",r:43.4,a:4.9,ac:64,ob:30.9,db:11.7,g:55,p:73,u:0},
  "13159":{n:"Jasper",r:52.3,a:5.1,ac:60,ob:34.7,db:13.2,g:43,p:14,u:0},
  "13161":{n:"Jeff Davis",r:56.1,a:5.2,ac:59,ob:35.6,db:13.5,g:39,p:15,u:0},
  "13163":{n:"Jefferson",r:64.8,a:5.3,ac:57,ob:38.7,db:14.6,g:33,p:16,u:0},
  "13165":{n:"Jenkins",r:62.3,a:5.3,ac:57,ob:38.1,db:14.4,g:34,p:9,u:0},
  "13167":{n:"Johnson",r:59.4,a:5.2,ac:58,ob:37.0,db:14.1,g:37,p:10,u:0},
  "13169":{n:"Jones",r:48.7,a:5.1,ac:61,ob:32.9,db:12.5,g:47,p:28,u:0},
  "13171":{n:"Lamar",r:51.8,a:5.1,ac:60,ob:34.3,db:13.0,g:43,p:19,u:0},
  "13173":{n:"Lanier",r:55.4,a:5.1,ac:59,ob:35.6,db:13.5,g:39,p:10,u:0},
  "13175":{n:"Laurens",r:54.6,a:5.1,ac:59,ob:35.3,db:13.4,g:40,p:49,u:0},
  "13177":{n:"Lee",r:49.1,a:5.1,ac:61,ob:33.7,db:12.8,g:45,p:35,u:0},
  "13179":{n:"Liberty",r:46.8,a:5.0,ac:63,ob:31.8,db:12.0,g:53,p:65,u:0},
  "13181":{n:"Lincoln",r:55.7,a:5.1,ac:59,ob:35.8,db:13.6,g:39,p:8,u:0},
  "13183":{n:"Long",r:47.2,a:5.0,ac:62,ob:32.4,db:12.3,g:50,p:16,u:0},
  "13185":{n:"Lowndes",r:50.4,a:5.1,ac:61,ob:33.8,db:12.8,g:45,p:118,u:0},
  "13187":{n:"Lumpkin",r:43.9,a:4.9,ac:63,ob:30.8,db:11.6,g:55,p:31,u:0},
  "13189":{n:"McDuffie",r:56.8,a:5.2,ac:59,ob:36.2,db:13.8,g:38,p:21,u:0},
  "13191":{n:"McIntosh",r:52.4,a:5.1,ac:60,ob:34.8,db:13.2,g:43,p:14,u:0},
  "13193":{n:"Macon",r:66.7,a:5.3,ac:56,ob:39.4,db:14.9,g:31,p:13,u:0},
  "13195":{n:"Madison",r:48.3,a:5.1,ac:61,ob:33.2,db:12.6,g:46,p:30,u:0},
  "13197":{n:"Marion",r:61.2,a:5.3,ac:58,ob:37.6,db:14.2,g:35,p:8,u:0},
  "13199":{n:"Meriwether",r:57.3,a:5.2,ac:59,ob:36.4,db:13.9,g:38,p:21,u:0},
  "13201":{n:"Miller",r:60.4,a:5.2,ac:58,ob:37.2,db:14.2,g:36,p:6,u:0},
  "13205":{n:"Mitchell",r:63.8,a:5.3,ac:57,ob:38.3,db:14.5,g:34,p:23,u:0},
  "13207":{n:"Monroe",r:49.6,a:5.1,ac:61,ob:33.6,db:12.8,g:45,p:28,u:0},
  "13209":{n:"Montgomery",r:56.2,a:5.2,ac:59,ob:35.9,db:13.6,g:38,p:9,u:0},
  "13211":{n:"Morgan",r:47.4,a:5.0,ac:62,ob:32.1,db:12.2,g:50,p:20,u:0},
  "13213":{n:"Murray",r:48.1,a:5.0,ac:61,ob:33.0,db:12.5,g:47,p:39,u:0},
  "13215":{n:"Muscogee",r:54.3,a:5.1,ac:60,ob:35.1,db:13.3,g:41,p:196,u:1},
  "13217":{n:"Newton",r:46.7,a:5.0,ac:62,ob:31.7,db:12.0,g:52,p:106,u:1},
  "13219":{n:"Oconee",r:36.8,a:4.9,ac:69,ob:28.6,db:10.8,g:66,p:40,u:1},
  "13221":{n:"Oglethorpe",r:50.2,a:5.1,ac:61,ob:33.9,db:12.9,g:44,p:14,u:0},
  "13223":{n:"Paulding",r:41.3,a:4.9,ac:67,ob:30.1,db:11.4,g:62,p:163,u:1},
  "13225":{n:"Peach",r:58.4,a:5.2,ac:59,ob:36.8,db:14.0,g:37,p:28,u:0},
  "13227":{n:"Pickens",r:42.7,a:5.0,ac:64,ob:30.9,db:11.7,g:55,p:35,u:0},
  "13229":{n:"Pierce",r:53.1,a:5.1,ac:60,ob:34.6,db:13.1,g:42,p:18,u:0},
  "13231":{n:"Pike",r:48.6,a:5.0,ac:61,ob:32.8,db:12.5,g:47,p:19,u:0},
  "13233":{n:"Polk",r:50.8,a:5.1,ac:60,ob:34.1,db:13.0,g:44,p:42,u:0},
  "13235":{n:"Pulaski",r:59.3,a:5.2,ac:58,ob:36.9,db:14.1,g:36,p:12,u:0},
  "13237":{n:"Putnam",r:51.4,a:5.1,ac:60,ob:34.2,db:13.0,g:43,p:22,u:0},
  "13239":{n:"Quitman",r:68.1,a:5.4,ac:55,ob:40.1,db:15.1,g:30,p:2,u:0},
  "13241":{n:"Rabun",r:44.2,a:5.0,ac:62,ob:31.7,db:12.0,g:51,p:17,u:0},
  "13243":{n:"Randolph",r:67.8,a:5.3,ac:56,ob:39.6,db:14.9,g:31,p:7,u:0},
  "13245":{n:"Richmond",r:56.7,a:5.2,ac:59,ob:36.3,db:13.8,g:38,p:201,u:1},
  "13247":{n:"Rockdale",r:44.8,a:5.0,ac:64,ob:31.1,db:11.8,g:54,p:96,u:1},
  "13249":{n:"Schley",r:57.6,a:5.2,ac:58,ob:36.7,db:13.9,g:37,p:5,u:0},
  "13251":{n:"Screven",r:60.4,a:5.2,ac:58,ob:37.3,db:14.2,g:36,p:15,u:0},
  "13253":{n:"Seminole",r:59.8,a:5.2,ac:58,ob:37.2,db:14.1,g:36,p:9,u:0},
  "13255":{n:"Spalding",r:52.1,a:5.1,ac:60,ob:34.6,db:13.1,g:42,p:68,u:0},
  "13257":{n:"Stephens",r:48.4,a:5.0,ac:61,ob:32.9,db:12.5,g:47,p:26,u:0},
  "13259":{n:"Stewart",r:66.3,a:5.3,ac:57,ob:39.2,db:14.8,g:31,p:6,u:0},
  "13261":{n:"Sumter",r:61.8,a:5.3,ac:58,ob:37.9,db:14.4,g:35,p:33,u:0},
  "13263":{n:"Talbot",r:63.4,a:5.3,ac:57,ob:38.8,db:14.7,g:33,p:7,u:0},
  "13265":{n:"Taliaferro",r:70.2,a:5.4,ac:55,ob:40.8,db:15.2,g:30,p:2,u:0},
  "13267":{n:"Tattnall",r:55.7,a:5.1,ac:59,ob:35.7,db:13.6,g:39,p:25,u:0},
  "13269":{n:"Taylor",r:62.6,a:5.3,ac:57,ob:38.4,db:14.5,g:34,p:8,u:0},
  "13271":{n:"Telfair",r:60.8,a:5.2,ac:58,ob:37.4,db:14.2,g:36,p:17,u:0},
  "13273":{n:"Terrell",r:65.4,a:5.3,ac:57,ob:39.0,db:14.8,g:32,p:9,u:0},
  "13275":{n:"Thomas",r:53.6,a:5.1,ac:59,ob:35.1,db:13.3,g:41,p:45,u:0},
  "13277":{n:"Tift",r:52.8,a:5.1,ac:60,ob:34.8,db:13.2,g:43,p:40,u:0},
  "13279":{n:"Toombs",r:55.2,a:5.1,ac:59,ob:35.5,db:13.5,g:40,p:27,u:0},
  "13281":{n:"Towns",r:42.6,a:5.0,ac:63,ob:30.6,db:11.5,g:54,p:11,u:0},
  "13283":{n:"Treutlen",r:58.3,a:5.2,ac:58,ob:36.5,db:13.8,g:37,p:7,u:0},
  "13285":{n:"Troup",r:51.7,a:5.1,ac:60,ob:34.4,db:13.1,g:43,p:71,u:0},
  "13287":{n:"Turner",r:60.1,a:5.2,ac:58,ob:37.1,db:14.1,g:36,p:9,u:0},
  "13289":{n:"Twiggs",r:63.7,a:5.3,ac:57,ob:38.6,db:14.6,g:33,p:8,u:0},
  "13291":{n:"Union",r:43.4,a:5.0,ac:63,ob:30.7,db:11.6,g:55,p:22,u:0},
  "13293":{n:"Upson",r:54.2,a:5.1,ac:59,ob:35.0,db:13.3,g:41,p:27,u:0},
  "13295":{n:"Walker",r:47.3,a:5.0,ac:61,ob:32.7,db:12.4,g:48,p:68,u:0},
  "13297":{n:"Walton",r:44.6,a:5.0,ac:63,ob:31.0,db:11.8,g:53,p:91,u:0},
  "13299":{n:"Ware",r:56.4,a:5.2,ac:59,ob:35.9,db:13.6,g:38,p:36,u:0},
  "13301":{n:"Warren",r:65.1,a:5.3,ac:57,ob:39.1,db:14.8,g:32,p:6,u:0},
  "13303":{n:"Washington",r:61.7,a:5.3,ac:58,ob:37.8,db:14.3,g:35,p:21,u:0},
  "13305":{n:"Wayne",r:53.8,a:5.1,ac:59,ob:35.2,db:13.3,g:40,p:29,u:0},
  "13307":{n:"Webster",r:67.6,a:5.3,ac:56,ob:39.8,db:15.0,g:31,p:3,u:0},
  "13309":{n:"Wheeler",r:59.7,a:5.2,ac:58,ob:37.1,db:14.1,g:37,p:8,u:0},
  "13311":{n:"White",r:43.1,a:5.0,ac:64,ob:30.8,db:11.7,g:55,p:28,u:0},
  "13313":{n:"Whitfield",r:46.8,a:5.0,ac:62,ob:32.1,db:12.2,g:50,p:103,u:0},
  "13315":{n:"Wilcox",r:61.3,a:5.3,ac:58,ob:37.7,db:14.3,g:35,p:7,u:0},
  "13317":{n:"Wilkes",r:58.4,a:5.2,ac:59,ob:36.7,db:13.9,g:37,p:10,u:0},
  "13319":{n:"Wilkinson",r:57.1,a:5.2,ac:59,ob:36.3,db:13.8,g:38,p:10,u:0},
  "13321":{n:"Worth",r:56.8,a:5.2,ac:59,ob:36.1,db:13.7,g:38,p:21,u:0}
};

// â”€â”€ Map Setup â”€â”€
const map = L.map('map', {
  center: [CONFIG.mapCenterLat, CONFIG.mapCenterLng],
  zoom: CONFIG.mapZoom,
  zoomControl: false
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd', maxZoom: 19
}).addTo(map);

// â”€â”€ State â”€â”€
let markers = {};
let selectedHospital = null;
let activeFilter = 'all';
let activeSortKey = 'infrastructure_score';
let choroplethLayer = null;
let choroplethVisible = false;

// â”€â”€ Utility Functions â”€â”€
function fmt(n) { return n != null ? n.toLocaleString() : 'â€”'; }

function getCertColor(cert) {
  const colors = { CSC: '#EB1700', PSC: '#F59E0B', TSC: '#0077C8', TCC: '#0077C8' };
  return colors[cert] || '#6B7280';
}

function getTierColor(tier) {
  const colors = { 1: '#059669', 2: '#F59E0B', 3: '#6B7280' };
  return colors[tier] || '#6B7280';
}

function getGeoAccessClass(access) {
  const m = { 'Local': 'local', 'Short': 'short', 'Long': 'long', 'Flight Required': 'flight' };
  return m[access] || 'short';
}

function getGeoAccessIcon(access) {
  const m = { 'Local': 'ðŸ“', 'Short': 'ðŸš—', 'Long': 'ðŸš™', 'Flight Required': 'âœˆï¸' };
  return m[access] || 'ðŸ“';
}

function markerSize(strokes) {
  const maxStrokes = Math.max(...HOSPITALS.map(h => h.strokes_yr));
  const minSize = 18, maxSize = 42;
  if (maxStrokes === 0) return minSize;
  return Math.round(minSize + (strokes / maxStrokes) * (maxSize - minSize));
}

function checkIcon(val) {
  return val ? '<span class="infra-check-icon yes">âœ“</span>' : '<span class="infra-check-icon no">âœ—</span>';
}

function toggleSources(id, btn) {
  var body = document.getElementById(id);
  var chevron = btn.querySelector('.sources-chevron');
  if (body.classList.contains('open')) {
    body.classList.remove('open');
    chevron.classList.remove('open');
  } else {
    body.classList.add('open');
    chevron.classList.add('open');
  }
}

// â”€â”€ County Flyaway Card â”€â”€
var countyFlyawayEl = document.getElementById('countyFlyaway');
var activeFlyawayFips = null;

function getAfibColor(afib) {
  return afib >= 6.5 ? '#DC2626' : afib >= 5.5 ? '#F97316' : afib >= 4.5 ? '#FBBF24' : afib >= 3.5 ? '#84CC16' : '#22C55E';
}

function getAfibLabel(afib) {
  return afib >= 6.5 ? 'High' : afib >= 5.5 ? 'Elevated' : afib >= 4.5 ? 'Moderate' : afib >= 3.5 ? 'Low-Mod' : 'Low';
}

function showCountyFlyaway(fips, latlng) {
  var d = COUNTY_DATA[fips];
  if (!d) return;
  activeFlyawayFips = fips;
  var stateCode = String(fips).substring(0, 2);
  var stateName = stateCode === '12' ? 'Florida' : 'Georgia';
  var afibColor = getAfibColor(d.a);
  var afibLabel = getAfibLabel(d.a);
  // Territory averages for comparison
  var avgAfib = 5.2, avgMort = 48.6, avgAc = 63, avgOb = 32.8;

  var html = '<div class="county-flyaway-header">' +
    '<div class="county-flyaway-header-left">' +
    '<div><div class="county-flyaway-name">' + d.n + ' County</div>' +
    '<div class="county-flyaway-state">' + stateName + ' Â· FIPS ' + fips + ' Â· Pop ' + fmt(d.p * 1000) + ' Â· ' + (d.u ? 'Urban' : 'Rural') + '</div></div>' +
    '</div>' +
    '<span class="county-flyaway-badge" style="background:' + afibColor + '">' + afibLabel + '</span>' +
    '<button class="county-flyaway-close" onclick="closeCountyFlyaway()">âœ•</button>' +
    '</div>' +
    '<div class="county-flyaway-body">' +
    '<div class="county-flyaway-grid">' +
    '<div class="county-flyaway-card afib">' +
    '<div class="county-flyaway-card-label">A-Fib Prevalence</div>' +
    '<div class="county-flyaway-card-value">' + d.a.toFixed(1) + '%</div>' +
    '<div class="county-flyaway-card-sub">' + (d.a > avgAfib ? 'â†‘' : 'â†“') + ' vs ' + avgAfib + '% territory avg</div>' +
    '</div>' +
    '<div class="county-flyaway-card mortality">' +
    '<div class="county-flyaway-card-label">Stroke Mortality</div>' +
    '<div class="county-flyaway-card-value">' + d.r.toFixed(1) + '</div>' +
    '<div class="county-flyaway-card-sub">per 100k ' + (d.r > avgMort ? 'â†‘' : 'â†“') + ' vs ' + avgMort + ' avg</div>' +
    '</div>' +
    '<div class="county-flyaway-card anticoag">' +
    '<div class="county-flyaway-card-label">Anticoag Use</div>' +
    '<div class="county-flyaway-card-value">' + d.ac + '%</div>' +
    '<div class="county-flyaway-card-sub">Medicare bene ' + (d.ac > avgAc ? 'â†‘' : 'â†“') + ' vs ' + avgAc + '% avg</div>' +
    '</div>' +
    '<div class="county-flyaway-card glp1">' +
    '<div class="county-flyaway-card-label">GLP-1 Rx Index</div>' +
    '<div class="county-flyaway-card-value">' + d.g + '</div>' +
    '<div class="county-flyaway-card-sub">0-100 prescribing index</div>' +
    '</div>' +
    '</div>' +
    '<div class="county-flyaway-bars">' +
    '<div class="county-flyaway-bar-row">' +
    '<span class="county-flyaway-bar-label">Obesity</span>' +
    '<div class="county-flyaway-bar-track"><div class="county-flyaway-bar-fill" style="width:' + Math.round(d.ob / 45 * 100) + '%;background:#F97316;"></div></div>' +
    '<span class="county-flyaway-bar-val">' + d.ob + '%</span>' +
    '</div>' +
    '<div class="county-flyaway-bar-row">' +
    '<span class="county-flyaway-bar-label">Diabetes</span>' +
    '<div class="county-flyaway-bar-track"><div class="county-flyaway-bar-fill" style="width:' + Math.round(d.db / 18 * 100) + '%;background:#DC2626;"></div></div>' +
    '<span class="county-flyaway-bar-val">' + d.db + '%</span>' +
    '</div>' +
    '<div class="county-flyaway-bar-row">' +
    '<span class="county-flyaway-bar-label">A-Fib</span>' +
    '<div class="county-flyaway-bar-track"><div class="county-flyaway-bar-fill" style="width:' + Math.round(d.a / 8 * 100) + '%;background:' + afibColor + ';"></div></div>' +
    '<span class="county-flyaway-bar-val">' + d.a + '%</span>' +
    '</div>' +
    '</div></div>' +
    '<div class="county-flyaway-footer">Sources: CMS Chronic Conditions Warehouse Â· BRFSS Â· CDC WONDER Â· CMS Part D PUF</div>';

  countyFlyawayEl.innerHTML = html;
  // Position the flyaway near the click point
  var mapRect = document.getElementById('map').getBoundingClientRect();
  var point = map.latLngToContainerPoint(latlng);
  var left = point.x + mapRect.left + 16;
  var top = point.y + mapRect.top - 80;
  // Keep within viewport
  if (left + 360 > window.innerWidth) left = point.x + mapRect.left - 360;
  if (top < mapRect.top) top = mapRect.top + 10;
  if (top + 340 > window.innerHeight) top = window.innerHeight - 360;
  countyFlyawayEl.style.left = left + 'px';
  countyFlyawayEl.style.top = top + 'px';
  countyFlyawayEl.classList.add('visible');
}

function closeCountyFlyaway() {
  countyFlyawayEl.classList.remove('visible');
  activeFlyawayFips = null;
}

// Close flyaway when clicking on map (but not on choropleth)
map.on('click', function(e) {
  if (activeFlyawayFips) closeCountyFlyaway();
});

// â”€â”€ Choropleth Functions â”€â”€
function getCountyColor(rate) {
  return rate > 68 ? '#b10026' :
         rate > 58 ? '#e31a1c' :
         rate > 50 ? '#fc4e2a' :
         rate > 44 ? '#fd8d3c' :
         rate > 38 ? '#feb24c' :
         rate > 30 ? '#fed976' :
                     '#ffffb2';
}

function getCountyRate(fips) {
  var d = COUNTY_DATA[fips];
  if (d) return d.r;
  // Fallback: derive from state FIPS
  var stateCode = String(fips).substring(0, 2);
  var countyNum = parseInt(String(fips).substring(2));
  var base = stateCode === '12' ? 42.0 : 52.0;
  // Deterministic pseudo-random variance
  var hash = ((countyNum * 2654435761) >>> 0) % 1000;
  return Math.round((base + (hash / 1000 - 0.5) * 20) * 10) / 10;
}

function getCountyName(fips) {
  var d = COUNTY_DATA[fips];
  if (d) return d.n + ' County';
  var stateCode = String(fips).substring(0, 2);
  return (stateCode === '12' ? 'FL' : 'GA') + ' County ' + String(fips).substring(2);
}

async function loadChoropleth() {
  try {
    showToast('Loading county stroke mortality data...');
    var response = await fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json');
    var us = await response.json();
    var counties = topojson.feature(us, us.objects.counties);

    // Filter to FL (12) and GA (13)
    var flgaFeatures = counties.features.filter(function(f) {
      var stateCode = String(f.id).substring(0, 2);
      return stateCode === '12' || stateCode === '13';
    });

    var flgaCounties = { type: "FeatureCollection", features: flgaFeatures };

    choroplethLayer = L.geoJSON(flgaCounties, {
      style: function(feature) {
        var fips = String(feature.id);
        var rate = getCountyRate(fips);
        return {
          fillColor: getCountyColor(rate),
          weight: 0.8,
          opacity: 0.7,
          color: '#999',
          fillOpacity: 0.55
        };
      },
      onEachFeature: function(feature, layer) {
        var fips = String(feature.id);
        var name = getCountyName(fips);
        var rate = getCountyRate(fips);
        var d = COUNTY_DATA[fips];
        var stateCode = fips.substring(0, 2);
        var stateName = stateCode === '12' ? 'Florida' : 'Georgia';
        var tooltipText = '<div class="county-name">' + name + '</div>' +
          '<div style="font-size:10px;color:#64748b;">' + stateName + ' (FIPS: ' + fips + ')</div>' +
          '<div class="county-rate" style="margin-top:3px;">' +
          'Stroke Mortality: <strong>' + rate.toFixed(1) + '</strong>/100k' +
          '</div>';
        if (d && d.a) {
          tooltipText += '<div style="font-size:10px;margin-top:2px;">A-Fib: <strong>' + d.a.toFixed(1) + '%</strong></div>';
        }
        tooltipText += '<div style="font-size:9px;color:#94a3b8;margin-top:3px;">Click for detail card</div>';
        layer.bindTooltip(tooltipText, { sticky: true, direction: 'top', offset: [0, -10] });
        layer.on('click', function(e) {
          L.DomEvent.stopPropagation(e);
          showCountyFlyaway(fips, e.latlng);
        });
      }
    });

    showToast('County mortality data loaded â€” use ðŸ”¬ Mortality to toggle');
  } catch(e) {
    console.error('Failed to load county choropleth:', e);
    showToast('Could not load county data (check network)');
  }
}

function toggleChoropleth() {
  if (!choroplethLayer) {
    showToast('County data still loading...');
    return;
  }
  if (choroplethVisible) {
    map.removeLayer(choroplethLayer);
    document.getElementById('choroplethLegend').style.display = 'none';
    document.getElementById('btnChoropleth').classList.remove('active');
    showToast('Mortality overlay hidden');
  } else {
    choroplethLayer.addTo(map);
    choroplethLayer.bringToBack();
    document.getElementById('choroplethLegend').style.display = 'block';
    document.getElementById('btnChoropleth').classList.add('active');
    showToast('CDC WONDER stroke mortality overlay shown');
  }
  choroplethVisible = !choroplethVisible;
}

// â”€â”€ Toast â”€â”€
function showToast(msg) {
  var container = document.getElementById('toastContainer');
  var toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = msg;
  container.appendChild(toast);
  requestAnimationFrame(function() { toast.classList.add('show'); });
  setTimeout(function() {
    toast.classList.remove('show');
    setTimeout(function() { toast.remove(); }, 300);
  }, 2500);
}

// â”€â”€ Create Markers â”€â”€
function createMarkers() {
  HOSPITALS.forEach(function(h, i) {
    var size = markerSize(h.strokes_yr);
    var icon = L.divIcon({
      className: '',
      html: '<div class="hospital-marker' + (h.clinical_tier === 1 ? ' tier-1' : '') + '" style="width:' + size + 'px;height:' + size + 'px;background:' + getCertColor(h.cert) + ';">' + h.clinical_tier + '</div>',
      iconSize: [size, size],
      iconAnchor: [size/2, size/2]
    });

    var marker = L.marker([h.lat, h.lng], { icon: icon, zIndexOffset: 1000 }).addTo(map);
    marker.on('click', function() { openPopup(h, marker); });
    markers[i] = marker;
  });
}

function openPopup(h, marker) {
  var tierColor = getTierColor(h.clinical_tier);
  var popupHtml = '<div class="popup-inner">' +
    '<div class="popup-name">' + h.short_name + '</div>' +
    '<div class="popup-cert"><span class="badge badge-cert" style="background:' + getCertColor(h.cert) + '">' + (h.cert || 'None') + '</span> ' +
    '<span class="badge badge-tier" style="background:' + tierColor + '">Tier ' + h.clinical_tier + '</span></div>' +
    '<div class="popup-stats">' +
    '<div><div class="popup-stat-label">Beds</div><div class="popup-stat-value">' + fmt(h.beds) + '</div></div>' +
    '<div><div class="popup-stat-label">Strokes/Yr</div><div class="popup-stat-value">' + fmt(h.strokes_yr) + '</div></div>' +
    '<div><div class="popup-stat-label">Est. LVO</div><div class="popup-stat-value">' + fmt(h.lvo_volume) + '</div></div>' +
    '<div><div class="popup-stat-label">Infra Score</div><div class="popup-stat-value">' + h.infrastructure_score + '</div></div>' +
    '</div>' +
    '<button class="popup-btn" onclick="openDrawer(' + HOSPITALS.indexOf(h) + ')">View Full Profile â†’</button>' +
    '</div>';
  marker.bindPopup(popupHtml, { maxWidth: 280 }).openPopup();
}

// â”€â”€ Sidebar Cards â”€â”€
function renderCards() {
  var list = document.getElementById('hospitalList');
  var filtered = HOSPITALS.filter(function(h) {
    if (activeFilter === 'all') return true;
    if (activeFilter === 'TSC') return h.cert === 'TSC' || h.cert === 'TCC';
    return h.cert === activeFilter;
  });

  var searchTerm = document.getElementById('searchInput').value.toLowerCase();
  if (searchTerm) {
    filtered = filtered.filter(function(h) {
      return h.name.toLowerCase().includes(searchTerm) ||
        h.short_name.toLowerCase().includes(searchTerm) ||
        h.city.toLowerCase().includes(searchTerm) ||
        h.affiliation.toLowerCase().includes(searchTerm);
    });
  }

  // Sort
  filtered.sort(function(a, b) {
    if (activeSortKey === 'name') return a.name.localeCompare(b.name);
    return (b[activeSortKey] || 0) - (a[activeSortKey] || 0);
  });

  // Update marker visibility
  HOSPITALS.forEach(function(h, i) {
    var visible = filtered.includes(h);
    if (markers[i]) {
      if (visible) markers[i].addTo(map);
      else map.removeLayer(markers[i]);
    }
  });

  list.innerHTML = filtered.map(function(h, rank) {
    var idx = HOSPITALS.indexOf(h);
    var isSelected = selectedHospital === idx;
    var tierColor = getTierColor(h.clinical_tier);
    return '<div class="hospital-card' + (isSelected ? ' selected' : '') + '" onclick="selectHospital(' + idx + ')" data-idx="' + idx + '">' +
      '<div class="card-header">' +
      '<div class="card-rank">' + (rank + 1) + '</div>' +
      '<div class="card-name">' + h.name + '</div>' +
      '<div class="card-badges">' +
      '<span class="badge badge-cert" style="background:' + getCertColor(h.cert) + '">' + (h.cert || 'â€”') + '</span>' +
      '<span class="badge badge-tier" style="background:' + tierColor + '">T' + h.clinical_tier + '</span>' +
      '</div></div>' +
      '<div class="card-meta">' +
      '<span>' + fmt(h.beds) + ' beds</span>' +
      '<span>' + fmt(h.strokes_yr) + ' strokes/yr</span>' +
      '<span>' + h.affiliation + '</span>' +
      '</div>' +
      '<div style="display:flex;align-items:center;">' +
      '<div class="card-stats">' +
      '<div class="card-stat-item"><span class="card-stat-label">LVO: </span><span class="card-stat-value">' + fmt(h.lvo_volume) + '</span></div>' +
      '<div class="card-stat-item"><span class="card-stat-label">MT: </span><span class="card-stat-value">' + fmt(h.mt_eligible) + '</span></div>' +
      '</div>' +
      '<div class="card-infra-score" style="color:' + tierColor + '">IS: ' + h.infrastructure_score + '</div>' +
      '</div></div>';
  }).join('');
}

function selectHospital(idx) {
  selectedHospital = idx;
  var h = HOSPITALS[idx];
  renderCards();
  map.setView([h.lat, h.lng], Math.max(map.getZoom(), 10));
  if (markers[idx]) markers[idx].fire('click');
}

// â”€â”€ Account Drawer â”€â”€
function openDrawer(idx) {
  var h = HOSPITALS[idx];
  selectedHospital = idx;
  document.getElementById('drawerTitle').textContent = h.short_name;

  var tierColor = getTierColor(h.clinical_tier);
  var certColor = getCertColor(h.cert);

  // Prevalence max values for bar scaling
  var maxLvo = Math.max.apply(null, HOSPITALS.map(function(x) { return x.lvo_volume || 0; })) || 1;
  var maxIschemic = Math.max.apply(null, HOSPITALS.map(function(x) { return x.ischemic_volume || 0; })) || 1;
  var maxHemorrhagic = Math.max.apply(null, HOSPITALS.map(function(x) { return x.hemorrhagic_volume || 0; })) || 1;
  var maxAvm = Math.max.apply(null, HOSPITALS.map(function(x) { return x.avm_aneurysm_volume || 0; })) || 1;

  var cadenceMap = { 1: 'Weekly', 2: 'Twice/Month', 3: 'Monthly' };

  var html = '';

  // Source tooltip helper
  function src(text) { return '<span class="src-tip" data-src="' + text + '">i</span>'; }

  // â”€â”€ Hospital Profile â”€â”€
  html += '<div class="drawer-section">' +
    '<div class="drawer-section-title">Hospital Profile</div>' +
    '<div class="detail-grid">' +
    '<div class="detail-item"><div class="detail-label">Full Name</div><div class="detail-value" style="font-size:12px;">' + h.name + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Certification' + src(h.cert_body ? h.cert_body + ' QualityCheck Registry' : 'Hospital website') + '</div><div class="detail-value"><span class="badge badge-cert" style="background:' + certColor + '">' + (h.cert || 'None') + '</span>' + (h.cert_body ? ' <span style="font-size:10px;color:#94a3b8;">' + h.cert_body + '</span>' : '') + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Licensed Beds' + src('CMS Care Compare / AHD.com Medicare Cost Report') + '</div><div class="detail-value">' + fmt(h.beds) + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Strokes/Year' + src('AHA Get With The Guidelines / Hospital self-reported') + '</div><div class="detail-value">' + fmt(h.strokes_yr) + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Affiliation' + src('Hospital website / SEC filings') + '</div><div class="detail-value" style="font-size:12px;">' + h.affiliation + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">GPO</div><div class="detail-value" style="font-size:12px;">' + h.gpo + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Phone</div><div class="detail-value" style="font-size:12px;">' + h.phone + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">IR Phone</div><div class="detail-value" style="font-size:12px;">' + (h.ir_phone || 'â€”') + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Address</div><div class="detail-value" style="font-size:11px;">' + h.address + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">County</div><div class="detail-value" style="font-size:12px;">' + h.county + '</div></div>' +
    '</div></div>';

  // â”€â”€ Clinical Programs â”€â”€
  html += '<div class="drawer-section">' +
    '<div class="drawer-section-title">Clinical Programs</div>' +
    '<div class="detail-grid">' +
    '<div class="detail-item"><div class="detail-label">Neurosurgery Fellowship</div><div class="detail-value">' + (h.nsg_fellowship ? 'âœ“ Yes' : 'âœ— No') + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Neuro IR Fellowship</div><div class="detail-value">' + (h.nir_fellowship ? 'âœ“ Yes' : 'âœ— No') + '</div></div>' +
    '</div></div>';

  // â”€â”€ Infrastructure Score & Tier â”€â”€
  html += '<div class="drawer-section">' +
    '<div class="drawer-section-title">Clinical Priority' + src('Weighted composite: cert level + capabilities + fellowships + volume bonus') + '</div>' +
    '<div class="infra-gauge-container">' +
    '<div class="infra-gauge" style="background: conic-gradient(' + tierColor + ' ' + (h.infrastructure_score * 3.6) + 'deg, #e2e8f0 0);">' +
    '<div style="width:48px;height:48px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;">' +
    '<span class="infra-gauge-value" style="color:' + tierColor + '">' + h.infrastructure_score + '</span>' +
    '</div></div>' +
    '<div class="infra-gauge-info">' +
    '<div class="infra-tier-badge" style="background:' + tierColor + '">Tier ' + h.clinical_tier + ' â€” ' + h.clinical_tier_label + '</div>' +
    '<div class="infra-tier-desc">Infrastructure Score: ' + h.infrastructure_score + '/100</div>' +
    '<div style="font-size:11px;color:#94a3b8;margin-top:2px;">' + cadenceMap[h.clinical_tier] + ' cadence recommended</div>' +
    '</div></div></div>';

  // â”€â”€ Infrastructure Checklist â”€â”€
  html += '<div class="drawer-section">' +
    '<div class="drawer-section-title">Infrastructure Checklist</div>' +
    '<div class="infra-checklist">' +
    '<div class="infra-check-item">' + checkIcon(h.thrombectomy_24_7) + '<span class="infra-check-label">24/7 Thrombectomy</span></div>' +
    '<div class="infra-check-item">' + checkIcon(h.neuro_icu) + '<span class="infra-check-label">Neuro ICU</span></div>' +
    '<div class="infra-check-item">' + checkIcon(h.ct_scanner) + '<span class="infra-check-label">CT Scanner</span></div>' +
    '<div class="infra-check-item">' + checkIcon(h.tpa_available) + '<span class="infra-check-label">tPA Available</span></div>' +
    '<div class="infra-check-item">' + checkIcon(h.telestroke) + '<span class="infra-check-label">Telestroke</span></div>' +
    '<div class="infra-check-item">' + checkIcon(h.cah) + '<span class="infra-check-label">Critical Access</span></div>' +
    '<div class="infra-check-item">' + checkIcon(h.spoke_hospital) + '<span class="infra-check-label">Spoke Hospital</span></div>' +
    '<div class="infra-check-item">' + checkIcon(h.medevac_available) + '<span class="infra-check-label">Medevac</span></div>' +
    '</div></div>';

  // â”€â”€ Catchment Demographics â”€â”€
  if (h.pop_total > 0) {
    html += '<div class="drawer-section">' +
      '<div class="drawer-section-title">Catchment Demographics' + src('US Census Bureau ACS 5-Year Estimates / CDC WONDER') + '</div>' +
      '<div class="detail-grid" style="margin-bottom:12px;">' +
      '<div class="detail-item"><div class="detail-label">Total Population</div><div class="detail-value">' + fmt(h.pop_total) + '</div></div>' +
      '<div class="detail-item"><div class="detail-label">Population 65+</div><div class="detail-value">' + fmt(h.pop_65_plus) + ' (' + h.pop_65_pct + '%)</div></div>' +
      '<div class="detail-item"><div class="detail-label">Effective Population' + src('Age-adjusted: pop_under_65 + (pop_65+ Ã— 2.5) â€” CDC MMWR 2019 age-adjusted stroke incidence') + '</div><div class="detail-value">' + fmt(h.effective_pop) + '</div></div>' +
      '<div class="detail-item"><div class="detail-label">Median Age</div><div class="detail-value">' + (h.median_age || 'â€”') + '</div></div>' +
      '<div class="detail-item"><div class="detail-label">Life Expectancy</div><div class="detail-value">' + (h.life_expectancy || 'â€”') + '</div></div>' +
      '</div></div>';
  }

  // â”€â”€ Stroke Epidemiology â”€â”€
  html += '<div class="drawer-section">' +
    '<div class="drawer-section-title">Stroke Epidemiology (Estimated)' + src('Rai AT et al. JNIS 2023;15:e349-e355 Â· DAWN/DEFUSE-3 trials Â· AHA Stats 2024 Â· GBD 2019') + '</div>';

  if (h.ischemic_volume > 0 || h.strokes_yr > 0) {
    html += '<div class="epi-summary">' +
      '<div class="epi-card"><div class="epi-card-value">' + fmt(h.ischemic_volume) + '</div><div class="epi-card-label">Ischemic/Yr</div></div>' +
      '<div class="epi-card"><div class="epi-card-value">' + fmt(h.lvo_volume) + '</div><div class="epi-card-label">LVO Cases</div></div>' +
      '<div class="epi-card"><div class="epi-card-value">' + fmt(h.mt_eligible) + '</div><div class="epi-card-label">MT Eligible' + src('70% of LVO â€” DAWN (NEJM 2018) & DEFUSE-3 (NEJM 2018) eligibility criteria') + '</div></div>' +
      '</div>';

    html += '<div class="prev-bar-container">' +
      '<div class="prev-bar-label"><span class="prev-bar-name">Ischemic (216/100k eff. pop)' + src('Rai AT et al. JNIS 2023;15:e349-e355') + '</span><span class="prev-bar-val">' + fmt(h.ischemic_volume) + '/yr</span></div>' +
      '<div class="prev-bar"><div class="prev-bar-fill" style="width:' + Math.round(h.ischemic_volume / maxIschemic * 100) + '%;background:var(--jnj-red);"></div></div>' +
      '</div>';

    html += '<div class="prev-bar-container">' +
      '<div class="prev-bar-label"><span class="prev-bar-name">LVO (21% of ischemic)' + src('Rai AT et al. JNIS 2023 â€” 21% (95% CI 15-29%) of AIS have vascular occlusion') + '</span><span class="prev-bar-val">' + fmt(h.lvo_volume) + '/yr</span></div>' +
      '<div class="prev-bar"><div class="prev-bar-fill" style="width:' + Math.round(h.lvo_volume / maxLvo * 100) + '%;background:var(--jnj-blue);"></div></div>' +
      '</div>';

    html += '<div class="prev-bar-container">' +
      '<div class="prev-bar-label"><span class="prev-bar-name">Hemorrhagic (12/100k)' + src('AHA Heart Disease & Stroke Statistics 2024 Update') + '</span><span class="prev-bar-val">' + fmt(h.hemorrhagic_volume) + '/yr</span></div>' +
      '<div class="prev-bar"><div class="prev-bar-fill" style="width:' + Math.round(h.hemorrhagic_volume / maxHemorrhagic * 100) + '%;background:#7C3AED;"></div></div>' +
      '</div>';

    html += '<div class="prev-bar-container">' +
      '<div class="prev-bar-label"><span class="prev-bar-name">AVM/Aneurysm (12/100k)' + src('GBD 2019 (Lancet Neurol 2021;20:795-820)') + '</span><span class="prev-bar-val">' + fmt(h.avm_aneurysm_volume) + '/yr</span></div>' +
      '<div class="prev-bar"><div class="prev-bar-fill" style="width:' + Math.round(h.avm_aneurysm_volume / maxAvm * 100) + '%;background:#059669;"></div></div>' +
      '</div>';

    // Hemorrhagic subtypes
    if (h.hemorrhagic_volume > 0) {
      html += '<div style="margin-top:8px;padding:8px;background:#f8fafc;border-radius:6px;">' +
        '<div style="font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Hemorrhagic Subtypes</div>' +
        '<div class="detail-grid">' +
        '<div class="detail-item"><div class="detail-label">SAH (5%)</div><div class="detail-value">' + fmt(h.sah_volume) + '</div></div>' +
        '<div class="detail-item"><div class="detail-label">ICH (80%)</div><div class="detail-value">' + fmt(h.ich_volume) + '</div></div>' +
        '</div></div>';
    }
  } else {
    html += '<div style="padding:12px;background:#f8fafc;border-radius:6px;font-size:12px;color:#94a3b8;text-align:center;">No catchment population data â€” epidemiology estimates unavailable</div>';
  }
  html += '</div>';

  // â”€â”€ A-Fib (conditional) â”€â”€
  if (h.afib_prevalence > 0 || h.afib_count > 0) {
    html += '<div class="drawer-section">' +
      '<div class="drawer-section-title">Atrial Fibrillation</div>' +
      '<div class="detail-grid">' +
      '<div class="detail-item"><div class="detail-label">Prevalence</div><div class="detail-value">' + (h.afib_prevalence ? h.afib_prevalence + '%' : 'â€”') + '</div></div>' +
      '<div class="detail-item"><div class="detail-label">Absolute Count</div><div class="detail-value">' + (h.afib_count ? fmt(h.afib_count) : 'â€”') + '</div></div>' +
      '<div class="detail-item"><div class="detail-label">MMAE Score</div><div class="detail-value">' + (h.mmae_score || 'â€”') + '</div></div>' +
      '<div class="detail-item"><div class="detail-label">Benefit Radius</div><div class="detail-value">' + (h.clinical_benefit_radius ? h.clinical_benefit_radius + ' km' : 'â€”') + '</div></div>' +
      '</div></div>';
  }

  // â”€â”€ GLP-1 RA Usage (conditional) â”€â”€
  if (h.glp1_rx_rate > 0 || h.glp1_est_users > 0) {
    html += '<div class="drawer-section">' +
      '<div class="drawer-section-title">GLP-1 Receptor Agonist Usage' + src('CMS Medicare Part D Prescriber PUF 2022 / IQVIA prescription data') + '</div>' +
      '<div class="glp1-cards">' +
      '<div class="glp1-card"><div class="glp1-card-value">' + (h.glp1_rx_rate ? h.glp1_rx_rate.toFixed(1) : 'â€”') + '</div><div class="glp1-card-label">Rx/1k Bene' + src('Prescriptions per 1,000 Medicare Part D beneficiaries â€” CMS.gov PUF') + '</div></div>' +
      '<div class="glp1-card"><div class="glp1-card-value">' + (h.glp1_market_penetration ? h.glp1_market_penetration.toFixed(1) + '%' : 'â€”') + '</div><div class="glp1-card-label">Mkt Penetration' + src('% of eligible diabetic/obese patients on GLP-1 RA â€” IQVIA') + '</div></div>' +
      '<div class="glp1-card"><div class="glp1-card-value">' + fmt(h.glp1_est_users) + '</div><div class="glp1-card-label">Est. Users' + src('Estimated absolute count in catchment area â€” CMS Part D Ã— Census pop') + '</div></div>' +
      '</div>' +
      '<div style="padding:8px;background:#faf5ff;border-radius:6px;font-size:10px;color:#7C3AED;line-height:1.5;">' +
      '<strong>Clinical relevance:</strong> SUSTAIN-6 (HR 0.61 stroke), LEADER (HR 0.86 MACE), SELECT 2023 (20% MACE reduction in non-diabetics). GLP-1 RA users may present with reduced stroke severity.' +
      '</div></div>';
  }

  // â”€â”€ Geographic Access & Travel â”€â”€
  html += '<div class="drawer-section">' +
    '<div class="drawer-section-title">Geographic Access & Travel' + src('Haversine distance Ã— 1.3 road factor Ã· 55 mph â€” closest team member') + '</div>' +
    '<div class="geo-access-badge ' + getGeoAccessClass(h.geographic_access) + '">' +
    getGeoAccessIcon(h.geographic_access) + ' ' + h.geographic_access +
    '</div>' +
    '<div class="detail-grid">' +
    '<div class="detail-item"><div class="detail-label">Closest Team Member</div><div class="detail-value" style="font-size:12px;">' + h.closest_team_member + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Distance</div><div class="detail-value">' + h.travel_miles + ' mi</div></div>' +
    '<div class="detail-item"><div class="detail-label">Drive Time</div><div class="detail-value">' + h.travel_time_min + ' min</div></div>' +
    '<div class="detail-item"><div class="detail-label">Recommended Cadence</div><div class="detail-value">' + cadenceMap[h.clinical_tier] + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Road Access</div><div class="detail-value">' + (h.road_access ? 'âœ“ Yes' : 'âœ— Limited') + '</div></div>' +
    '<div class="detail-item"><div class="detail-label">Medevac</div><div class="detail-value">' + (h.medevac_available ? 'âœ“ Available' : 'â€”') + '</div></div>' +
    '</div></div>';

  // â”€â”€ Comment â”€â”€
  if (h.comment) {
    html += '<div style="margin-top:4px;padding:8px;background:#fffbeb;border-radius:6px;font-size:11px;color:#92400e;">ðŸ’¡ ' + h.comment + '</div>';
  }

  // â”€â”€ Data Sources Panel (Collapsible) â”€â”€
  var sourcesId = 'sources-' + idx;
  html += '<div class="sources-panel" style="margin-top:16px;">' +
    '<button class="sources-toggle" onclick="toggleSources(\'' + sourcesId + '\', this)">' +
    '<span class="sources-panel-title">Data Sources & Citations</span>' +
    '<span class="sources-chevron">â–¼</span>' +
    '</button>' +
    '<div class="sources-body" id="' + sourcesId + '">' +
    '<div class="sources-panel-item"><strong>[1]</strong> Bed counts: CMS Care Compare / American Hospital Directory (AHD.com) Medicare Cost Report</div>' +
    '<div class="sources-panel-item"><strong>[2]</strong> Stroke certifications: Joint Commission QualityCheck / DNV GL Healthcare / FL AHCA CSC-PSC Registry</div>' +
    '<div class="sources-panel-item"><strong>[3]</strong> Ischemic stroke rate (216/100k) & LVO prevalence (21%): Rai AT et al. <em>J Neurointerv Surg</em> 2023;15:e349-e355</div>' +
    '<div class="sources-panel-item"><strong>[4]</strong> MT eligibility (70% of LVO): DAWN trial (<em>NEJM</em> 2018;378:11-21) & DEFUSE-3 (<em>NEJM</em> 2018;378:708-718)</div>' +
    '<div class="sources-panel-item"><strong>[5]</strong> Hemorrhagic stroke (12/100k), SAH/ICH subtypes: AHA Heart Disease & Stroke Statistics 2024 Update</div>' +
    '<div class="sources-panel-item"><strong>[6]</strong> AVM/Aneurysm (12/100k): Global Burden of Disease 2019 (<em>Lancet Neurol</em> 2021;20:795-820)</div>' +
    '<div class="sources-panel-item"><strong>[7]</strong> Age 65+ stroke multiplier (2.5Ã—): CDC MMWR 2019 age-adjusted stroke incidence data</div>' +
    '<div class="sources-panel-item"><strong>[8]</strong> Demographics: US Census Bureau ACS 5-Year Estimates / CDC WONDER</div>' +
    '<div class="sources-panel-item"><strong>[9]</strong> Travel times: Haversine formula Ã— 1.3 road factor Ã· 55 mph average</div>' +
    '<div class="sources-panel-item"><strong>[10]</strong> County stroke mortality: CDC WONDER Compressed Mortality 2018-2022 (ICD-10 I60-I69, age-adjusted)</div>' +
    '<div class="sources-panel-item"><strong>[11]</strong> GLP-1 RA usage: CMS Medicare Part D Prescriber PUF 2022 / IQVIA prescription data / SELECT trial (NEJM 2023)</div>' +
    '<div class="sources-panel-item" style="margin-top:6px;color:#94a3b8;font-style:italic;">Hover over <span class="src-tip" style="pointer-events:none;">i</span> icons throughout for field-specific sources.</div>' +
    '</div></div>';

  document.getElementById('drawerBody').innerHTML = html;
  document.getElementById('accountDrawer').classList.add('open');
  renderCards();
  showToast('Viewing ' + h.short_name);
}

function closeDrawer() {
  document.getElementById('accountDrawer').classList.remove('open');
  selectedHospital = null;
  renderCards();
}

// â”€â”€ Fit All â”€â”€
function fitAll() {
  var bounds = L.latLngBounds(HOSPITALS.map(function(h) { return [h.lat, h.lng]; }));
  map.fitBounds(bounds, { padding: [40, 40] });
  showToast('Map fitted to all markers');
}

// â”€â”€ Event Listeners â”€â”€
document.getElementById('drawerClose').addEventListener('click', closeDrawer);
document.getElementById('btnFitAll').addEventListener('click', fitAll);
document.getElementById('btnChoropleth').addEventListener('click', toggleChoropleth);
document.getElementById('btnZoomIn').addEventListener('click', function() { map.zoomIn(); });
document.getElementById('btnZoomOut').addEventListener('click', function() { map.zoomOut(); });

// Search
document.getElementById('searchInput').addEventListener('input', renderCards);

// Filters
document.querySelectorAll('.filter-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    activeFilter = btn.dataset.filter;
    renderCards();
  });
});

// Sort
document.getElementById('sortSelect').addEventListener('change', function(e) {
  activeSortKey = e.target.value;
  renderCards();
});

// â”€â”€ Initialize â”€â”€
createMarkers();
renderCards();
loadChoropleth();

// Close drawer on Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') { closeDrawer(); }
});
</script>
</body>
</html>
