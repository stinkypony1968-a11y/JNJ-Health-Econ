<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ config.territory_name }} â€” Territory Map | J&J MedTech Neurovascular</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --jnj-navy: #00205B;
  --jnj-red: #EB1700;
  --jnj-blue: #0077C8;
  --jnj-dark: #001A47;
  --sidebar-width: 380px;
  --drawer-width: 440px;
  --analytics-height: 64px;
  --header-height: 56px;
  --cert-csc: #EB1700;
  --cert-psc: #F59E0B;
  --cert-tsc: #0077C8;
  --cert-none: #6B7280;
  --tps-high: #059669;
  --tps-mid: #F59E0B;
  --tps-low: #6B7280;
  --dept-physician: #0077C8;
  --dept-stroke: #EB1700;
  --dept-education: #7C3AED;
  --dept-buying: #059669;
}
html, body { height: 100%; font-family: 'Inter', -apple-system, sans-serif; background: #f0f2f5; color: #1a1a2e; }
body { display: flex; flex-direction: column; overflow: hidden; }

/* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.header {
  height: var(--header-height); background: var(--jnj-navy);
  display: flex; align-items: center; padding: 0 20px; gap: 16px; z-index: 1000;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.header-logo {
  font-size: 13px; font-weight: 700; color: white; letter-spacing: 0.5px;
  display: flex; align-items: center; gap: 8px;
}
.header-logo .jnj-mark {
  width: 28px; height: 28px; background: var(--jnj-red); border-radius: 4px;
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 800; color: white; letter-spacing: 0;
}
.header-territory { font-size: 16px; font-weight: 600; color: white; flex: 1; }
.header-rep { font-size: 12px; color: rgba(255,255,255,0.7); }
.header-rep strong { color: white; font-weight: 600; }
.header-actions { display: flex; gap: 8px; }
.header-btn {
  background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2);
  color: white; padding: 6px 14px; border-radius: 6px; font-size: 12px;
  font-weight: 500; cursor: pointer; transition: all 0.15s;
  font-family: inherit;
}
.header-btn:hover { background: rgba(255,255,255,0.2); }
.header-btn.active { background: var(--jnj-blue); border-color: var(--jnj-blue); }

/* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main-container {
  flex: 1; display: flex; position: relative; overflow: hidden;
}

/* â”€â”€ Left Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width: var(--sidebar-width); background: white; display: flex;
  flex-direction: column; border-right: 1px solid #e2e8f0; z-index: 500;
}
.sidebar-header { padding: 12px 16px; border-bottom: 1px solid #e2e8f0; }
.sidebar-search {
  width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px;
  font-size: 13px; font-family: inherit; outline: none; transition: border 0.15s;
}
.sidebar-search:focus { border-color: var(--jnj-blue); }
.sidebar-filters {
  display: flex; gap: 4px; padding: 8px 16px; border-bottom: 1px solid #e2e8f0;
  flex-wrap: wrap;
}
.filter-btn {
  padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;
  cursor: pointer; border: 1px solid #e2e8f0; background: white; color: #64748b;
  transition: all 0.15s; font-family: inherit;
}
.filter-btn:hover { background: #f8fafc; }
.filter-btn.active { background: var(--jnj-navy); color: white; border-color: var(--jnj-navy); }
.sidebar-sort {
  display: flex; align-items: center; gap: 6px; padding: 6px 16px;
  border-bottom: 1px solid #e2e8f0; font-size: 11px; color: #94a3b8;
}
.sort-select {
  border: none; font-size: 11px; color: var(--jnj-navy); font-weight: 500;
  cursor: pointer; font-family: inherit; outline: none; background: transparent;
}
.sidebar-list {
  flex: 1; overflow-y: auto; padding: 8px;
}
.sidebar-list::-webkit-scrollbar { width: 5px; }
.sidebar-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

/* â”€â”€ Hospital Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hospital-card {
  padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 6px;
  cursor: pointer; transition: all 0.15s; position: relative;
}
.hospital-card:hover { border-color: var(--jnj-blue); box-shadow: 0 2px 8px rgba(0,119,200,0.1); }
.hospital-card.selected { border-color: var(--jnj-blue); background: #f0f7ff; }
.card-header { display: flex; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
.card-rank {
  width: 22px; height: 22px; border-radius: 50%; background: var(--jnj-navy);
  color: white; font-size: 10px; font-weight: 700; display: flex;
  align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px;
}
.card-name { font-size: 13px; font-weight: 600; color: var(--jnj-navy); flex: 1; line-height: 1.3; }
.card-badges { display: flex; gap: 4px; flex-shrink: 0; }
.badge {
  padding: 2px 7px; border-radius: 4px; font-size: 10px; font-weight: 600;
  letter-spacing: 0.3px; white-space: nowrap;
}
.badge-cert { color: white; }
.badge-tier { background: #f1f5f9; color: #475569; }
.card-meta { display: flex; flex-wrap: wrap; gap: 8px; font-size: 11px; color: #64748b; margin-bottom: 6px; padding-left: 30px; }
.card-meta span { display: flex; align-items: center; gap: 3px; }
.card-nts { display: flex; gap: 12px; padding-left: 30px; }
.card-nts-item { font-size: 11px; }
.card-nts-label { color: #94a3b8; }
.card-nts-value { font-weight: 600; color: var(--jnj-navy); }
.card-growth { font-weight: 600; font-size: 11px; margin-left: auto; padding-left: 30px; }
.card-growth.positive { color: #059669; }
.card-growth.negative { color: #dc2626; }

/* â”€â”€ Map Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.map-container { flex: 1; position: relative; }
#map { width: 100%; height: 100%; }
.leaflet-container { background: #dde6ed; }

/* Custom markers */
.hospital-marker {
  border-radius: 50%; border: 2.5px solid white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.15s;
  display: flex; align-items: center; justify-content: center;
  font-size: 8px; font-weight: 700; color: white; font-family: 'Inter', sans-serif;
}
.hospital-marker:hover { transform: scale(1.2); z-index: 9999 !important; }
.hospital-marker.tier-1 { border-width: 3px; }

/* Map controls */
.map-controls {
  position: absolute; top: 12px; right: 12px; z-index: 500;
  display: flex; flex-direction: column; gap: 6px;
}
.map-ctrl-btn {
  width: 36px; height: 36px; background: white; border: none; border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15); cursor: pointer; display: flex;
  align-items: center; justify-content: center; font-size: 16px;
  transition: all 0.15s; color: var(--jnj-navy);
}
.map-ctrl-btn:hover { background: #f0f7ff; }

/* â”€â”€ Right Drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.drawer {
  width: var(--drawer-width); background: white; position: absolute;
  top: 0; right: 0; height: 100%; z-index: 600;
  transform: translateX(100%); transition: transform 0.3s ease;
  box-shadow: -4px 0 16px rgba(0,0,0,0.1); display: flex; flex-direction: column;
  overflow: hidden;
}
.drawer.open { transform: translateX(0); }
.drawer-header {
  padding: 14px 16px; background: var(--jnj-navy); color: white;
  display: flex; align-items: center; justify-content: space-between;
}
.drawer-title { font-size: 14px; font-weight: 600; }
.drawer-close {
  width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.15);
  border: none; color: white; font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.drawer-body { flex: 1; overflow-y: auto; padding: 16px; }
.drawer-body::-webkit-scrollbar { width: 5px; }
.drawer-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

/* Drawer sections */
.drawer-section { margin-bottom: 20px; }
.drawer-section-title {
  font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px;
  color: #94a3b8; margin-bottom: 10px; padding-bottom: 6px;
  border-bottom: 1px solid #f1f5f9;
}
.detail-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
}
.detail-item { }
.detail-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
.detail-value { font-size: 13px; font-weight: 600; color: var(--jnj-navy); }

/* TPS gauge */
.tps-gauge-container { display: flex; align-items: center; gap: 16px; padding: 12px; background: #f8fafc; border-radius: 8px; }
.tps-gauge {
  width: 64px; height: 64px; border-radius: 50%; position: relative;
  display: flex; align-items: center; justify-content: center;
}
.tps-gauge-value { font-size: 20px; font-weight: 800; }
.tps-gauge-info { flex: 1; }
.tps-segment-badge {
  display: inline-block; padding: 3px 10px; border-radius: 4px;
  font-size: 11px; font-weight: 700; color: white; margin-bottom: 4px;
}
.tps-strategy { font-size: 12px; color: #64748b; }

/* Prevalence bars */
.prev-bar-container { margin-bottom: 8px; }
.prev-bar-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; }
.prev-bar-name { color: #64748b; }
.prev-bar-val { font-weight: 600; color: var(--jnj-navy); }
.prev-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
.prev-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }

/* Business plan */
.biz-plan { background: #f8fafc; border-radius: 8px; padding: 12px; }
.biz-plan-title { font-size: 13px; font-weight: 600; color: var(--jnj-navy); margin-bottom: 8px; }
.biz-plan-items { list-style: none; }
.biz-plan-items li {
  font-size: 12px; color: #475569; padding: 4px 0; padding-left: 16px;
  position: relative; line-height: 1.4;
}
.biz-plan-items li::before {
  content: ''; position: absolute; left: 0; top: 10px;
  width: 6px; height: 6px; border-radius: 50%; background: var(--jnj-blue);
}

/* â”€â”€ Calendar Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.calendar-panel {
  width: var(--drawer-width); background: white; position: absolute;
  top: 0; right: 0; height: 100%; z-index: 600;
  transform: translateX(100%); transition: transform 0.3s ease;
  box-shadow: -4px 0 16px rgba(0,0,0,0.1); display: flex; flex-direction: column;
}
.calendar-panel.open { transform: translateX(0); }
.calendar-header {
  padding: 14px 16px; background: var(--jnj-navy); color: white;
  display: flex; align-items: center; justify-content: space-between;
}
.calendar-body { flex: 1; overflow-y: auto; padding: 16px; }
.calendar-body::-webkit-scrollbar { width: 5px; }
.calendar-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

.cal-month { margin-bottom: 20px; }
.cal-month-title {
  font-size: 13px; font-weight: 700; color: var(--jnj-navy); margin-bottom: 8px;
  padding-bottom: 4px; border-bottom: 2px solid var(--jnj-navy);
}
.cal-week { display: grid; grid-template-columns: 60px 1fr; gap: 4px; margin-bottom: 4px; }
.cal-week-label { font-size: 10px; color: #94a3b8; padding-top: 4px; }
.cal-week-entries { display: flex; flex-wrap: wrap; gap: 3px; }
.cal-entry {
  padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;
  display: flex; align-items: center; gap: 4px; background: #f1f5f9;
}
.cal-dept-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }

/* Cadence legend */
.cadence-legend { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
.cadence-legend-item { display: flex; align-items: center; gap: 4px; font-size: 10px; color: #64748b; }

/* â”€â”€ Bottom Analytics Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.analytics-bar {
  height: var(--analytics-height); background: white; border-top: 1px solid #e2e8f0;
  display: flex; align-items: center; padding: 0 20px; gap: 24px; z-index: 500;
  box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
}
.analytics-item { display: flex; flex-direction: column; align-items: center; }
.analytics-label { font-size: 9px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
.analytics-value { font-size: 15px; font-weight: 700; color: var(--jnj-navy); }
.analytics-value.positive { color: #059669; }
.analytics-value.negative { color: #dc2626; }
.analytics-divider { width: 1px; height: 36px; background: #e2e8f0; }
.analytics-mini-bar { display: flex; gap: 2px; align-items: flex-end; height: 28px; }
.analytics-mini-bar-item { width: 18px; border-radius: 2px 2px 0 0; position: relative; }
.analytics-mini-bar-label {
  position: absolute; bottom: -14px; left: 50%; transform: translateX(-50%);
  font-size: 8px; color: #94a3b8; white-space: nowrap;
}
.analytics-gauge {
  width: 40px; height: 40px; border-radius: 50%; position: relative;
  display: flex; align-items: center; justify-content: center;
}
.analytics-gauge-value { font-size: 10px; font-weight: 700; color: var(--jnj-navy); }

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast-container {
  position: fixed; bottom: 80px; right: 20px; z-index: 9999;
  display: flex; flex-direction: column; gap: 8px;
}
.toast {
  padding: 10px 16px; border-radius: 8px; background: var(--jnj-navy);
  color: white; font-size: 12px; font-weight: 500;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(10px);
  transition: all 0.3s ease; max-width: 300px;
}
.toast.show { opacity: 1; transform: translateY(0); }

/* â”€â”€ Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.leaflet-popup-content-wrapper {
  border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); padding: 0;
}
.leaflet-popup-content { margin: 0; min-width: 240px; }
.popup-inner { padding: 14px; }
.popup-name { font-size: 14px; font-weight: 700; color: var(--jnj-navy); margin-bottom: 4px; }
.popup-cert { font-size: 11px; margin-bottom: 8px; }
.popup-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.popup-stat-label { font-size: 10px; color: #94a3b8; }
.popup-stat-value { font-size: 13px; font-weight: 600; color: var(--jnj-navy); }
.popup-btn {
  display: block; width: 100%; padding: 8px; background: var(--jnj-navy);
  color: white; border: none; border-radius: 6px; font-size: 12px;
  font-weight: 600; cursor: pointer; margin-top: 10px; font-family: inherit;
  transition: background 0.15s;
}
.popup-btn:hover { background: var(--jnj-blue); }

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 1200px) {
  :root { --sidebar-width: 320px; --drawer-width: 380px; }
}
@media (max-width: 1024px) {
  :root { --sidebar-width: 280px; --drawer-width: 100%; }
  .analytics-bar { gap: 12px; padding: 0 12px; overflow-x: auto; }
  .header-rep { display: none; }
}
</style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="header">
  <div class="header-logo">
    <div class="jnj-mark">J&J</div>
    MEDTECH NEUROVASCULAR
  </div>
  <div class="header-territory">{{ config.territory_name }}</div>
  <div class="header-rep"><strong>{{ config.rep_name }}</strong> Â· {{ config.rep_role }}{% if config.rep_base_city %} Â· {{ config.rep_base_city }}{% endif %}</div>
  <div class="header-actions">
    <button class="header-btn" id="btnFitAll" title="Fit All Markers">âŠž Fit All</button>
    <button class="header-btn" id="btnCalendar" title="Cadence Calendar">ðŸ“… Calendar</button>
  </div>
</div>

<!-- â”€â”€ Main Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="main-container">

  <!-- Left Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <input type="text" class="sidebar-search" id="searchInput" placeholder="Search hospitals..." />
    </div>
    <div class="sidebar-filters" id="filterBar">
      <button class="filter-btn active" data-filter="all">All ({{ hospital_count }})</button>
      {% if cert_counts.CSC > 0 %}<button class="filter-btn" data-filter="CSC">CSC ({{ cert_counts.CSC }})</button>{% endif %}
      {% if cert_counts.PSC > 0 %}<button class="filter-btn" data-filter="PSC">PSC ({{ cert_counts.PSC }})</button>{% endif %}
      {% if cert_counts.TSC > 0 or cert_counts.TCC > 0 %}<button class="filter-btn" data-filter="TSC">TSC ({{ cert_counts.TSC + cert_counts.TCC }})</button>{% endif %}
      {% if cert_counts.None > 0 %}<button class="filter-btn" data-filter="None">None ({{ cert_counts.None }})</button>{% endif %}
    </div>
    <div class="sidebar-sort">
      Sort by:
      <select class="sort-select" id="sortSelect">
        <option value="nts_2025">NTS 2025 â†“</option>
        <option value="tps_score">TPS Score â†“</option>
        <option value="yoy_growth">YoY Growth â†“</option>
        <option value="strokes_yr">Stroke Vol â†“</option>
        <option value="name">Name A-Z</option>
      </select>
    </div>
    <div class="sidebar-list" id="hospitalList"></div>
  </div>

  <!-- Map -->
  <div class="map-container">
    <div id="map"></div>
    <div class="map-controls">
      <button class="map-ctrl-btn" id="btnZoomIn" title="Zoom In">+</button>
      <button class="map-ctrl-btn" id="btnZoomOut" title="Zoom Out">âˆ’</button>
    </div>

    <!-- Right Drawer (Account Detail) -->
    <div class="drawer" id="accountDrawer">
      <div class="drawer-header">
        <span class="drawer-title" id="drawerTitle">Account Detail</span>
        <button class="drawer-close" id="drawerClose">âœ•</button>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
    </div>

    <!-- Calendar Panel -->
    <div class="calendar-panel" id="calendarPanel">
      <div class="calendar-header">
        <span class="drawer-title">Cadence Calendar â€” Marâ€“Aug 2026</span>
        <button class="drawer-close" id="calendarClose">âœ•</button>
      </div>
      <div class="calendar-body" id="calendarBody"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ Bottom Analytics Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="analytics-bar">
  <div class="analytics-item">
    <span class="analytics-label">Hospitals</span>
    <span class="analytics-value">{{ hospital_count }}</span>
  </div>
  <div class="analytics-divider"></div>
  <div class="analytics-item">
    <span class="analytics-label">NTS 2025</span>
    <span class="analytics-value">${{ "{:,}".format(total_nts_2025) }}</span>
  </div>
  <div class="analytics-divider"></div>
  <div class="analytics-item">
    <span class="analytics-label">NTS 2026 Ann.</span>
    <span class="analytics-value">${{ "{:,}".format(total_nts_2026_ann) }}</span>
  </div>
  <div class="analytics-divider"></div>
  <div class="analytics-item">
    <span class="analytics-label">YoY Growth</span>
    <span class="analytics-value {{ 'positive' if territory_yoy > 0 else 'negative' }}">{{ territory_yoy }}%</span>
  </div>
  <div class="analytics-divider"></div>
  <div class="analytics-item">
    <span class="analytics-label">Avg TPS</span>
    <span class="analytics-value">{{ avg_tps }}</span>
  </div>
  <div class="analytics-divider"></div>
  <div class="analytics-item">
    <span class="analytics-label">TPS Distribution</span>
    <div class="analytics-mini-bar">
      <div class="analytics-mini-bar-item" style="height:{{ [tps_dist.HIGH * 6, 4]|max }}px; background:var(--tps-high);"><span class="analytics-mini-bar-label">H:{{ tps_dist.HIGH }}</span></div>
      <div class="analytics-mini-bar-item" style="height:{{ [tps_dist.MID * 6, 4]|max }}px; background:var(--tps-mid);"><span class="analytics-mini-bar-label">M:{{ tps_dist.MID }}</span></div>
      <div class="analytics-mini-bar-item" style="height:{{ [tps_dist.LOW * 6, 4]|max }}px; background:var(--tps-low);"><span class="analytics-mini-bar-label">L:{{ tps_dist.LOW }}</span></div>
    </div>
  </div>
  <div class="analytics-divider"></div>
  <div class="analytics-item">
    <span class="analytics-label">Tiers</span>
    <span class="analytics-value" style="font-size:12px;">T1:{{ tier_counts[1] }} Â· T2:{{ tier_counts[2] }} Â· T3:{{ tier_counts[3] }}</span>
  </div>
  <div style="flex:1;"></div>
  <div class="analytics-item" style="opacity:0.5;">
    <span class="analytics-label">Generated</span>
    <span style="font-size:10px; color:#94a3b8;">{{ generated_date }}</span>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toastContainer"></div>

<!-- â”€â”€ JavaScript â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
// â”€â”€ Data â”€â”€
const HOSPITALS = {{ hospitals_json }};
const CONFIG = {
  repName: "{{ config.rep_name }}",
  repRole: "{{ config.rep_role }}",
  repBaseCity: "{{ config.rep_base_city }}",
  repBaseLat: {{ config.rep_base_lat }},
  repBaseLng: {{ config.rep_base_lng }},
  territoryName: "{{ config.territory_name }}",
  mapCenterLat: {{ config.map_center_lat }},
  mapCenterLng: {{ config.map_center_lng }},
  mapZoom: {{ config.map_zoom }},
  teamMembers: {{ config.team_members | tojson }}
};

// â”€â”€ Map Setup â”€â”€
const map = L.map('map', {
  center: [CONFIG.mapCenterLat, CONFIG.mapCenterLng],
  zoom: CONFIG.mapZoom,
  zoomControl: false
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd', maxZoom: 19
}).addTo(map);

// â”€â”€ State â”€â”€
let markers = {};
let selectedHospital = null;
let activeFilter = 'all';
let activeSortKey = 'nts_2025';

// â”€â”€ Utility Functions â”€â”€
function fmt(n) { return n != null ? n.toLocaleString() : 'â€”'; }
function fmtMoney(n) { return n != null ? '$' + n.toLocaleString() : 'â€”'; }

function getCertColor(cert) {
  const colors = { CSC: '#EB1700', PSC: '#F59E0B', TSC: '#0077C8', TCC: '#0077C8' };
  return colors[cert] || '#6B7280';
}

function getTpsColor(segment) {
  const colors = { HIGH: '#059669', MID: '#F59E0B', LOW: '#6B7280' };
  return colors[segment] || '#6B7280';
}

function markerSize(nts) {
  const maxNts = Math.max(...HOSPITALS.map(h => h.nts_2025));
  const minSize = 18, maxSize = 42;
  if (maxNts === 0) return minSize;
  return Math.round(minSize + (nts / maxNts) * (maxSize - minSize));
}

// â”€â”€ Toast â”€â”€
function showToast(msg) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = msg;
  container.appendChild(toast);
  requestAnimationFrame(() => toast.classList.add('show'));
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

// â”€â”€ Create Markers â”€â”€
function createMarkers() {
  HOSPITALS.forEach((h, i) => {
    const size = markerSize(h.nts_2025);
    const icon = L.divIcon({
      className: '',
      html: `<div class="hospital-marker${h.tier === 1 ? ' tier-1' : ''}" style="width:${size}px;height:${size}px;background:${getCertColor(h.cert)};">${h.tier}</div>`,
      iconSize: [size, size],
      iconAnchor: [size/2, size/2]
    });

    const marker = L.marker([h.lat, h.lng], { icon }).addTo(map);
    marker.on('click', () => openPopup(h, marker));
    markers[i] = marker;
  });
}

function openPopup(h, marker) {
  const growthClass = h.yoy_growth > 0 ? 'positive' : 'negative';
  const growthIcon = h.yoy_growth > 0 ? 'â†‘' : 'â†“';
  const popupHtml = `
    <div class="popup-inner">
      <div class="popup-name">${h.short_name}</div>
      <div class="popup-cert"><span class="badge badge-cert" style="background:${getCertColor(h.cert)}">${h.cert || 'None'}</span>
        <span class="badge badge-tier">Tier ${h.tier}</span></div>
      <div class="popup-stats">
        <div><div class="popup-stat-label">Beds</div><div class="popup-stat-value">${fmt(h.beds)}</div></div>
        <div><div class="popup-stat-label">Strokes/Yr</div><div class="popup-stat-value">${fmt(h.strokes_yr)}</div></div>
        <div><div class="popup-stat-label">NTS 2025</div><div class="popup-stat-value">${fmtMoney(h.nts_2025)}</div></div>
        <div><div class="popup-stat-label">YoY</div><div class="popup-stat-value" style="color:${h.yoy_growth > 0 ? '#059669' : '#dc2626'}">${growthIcon} ${Math.abs(h.yoy_growth)}%</div></div>
      </div>
      <div style="margin-top:6px;"><div class="popup-stat-label">TPS</div><div class="popup-stat-value">${h.tps_score} <span style="font-size:10px;color:${getTpsColor(h.tps_segment)}">${h.tps_segment}</span></div></div>
      <button class="popup-btn" onclick="openDrawer(${HOSPITALS.indexOf(h)})">View Full Profile â†’</button>
    </div>`;
  marker.bindPopup(popupHtml, { maxWidth: 280 }).openPopup();
}

// â”€â”€ Sidebar Cards â”€â”€
function renderCards() {
  const list = document.getElementById('hospitalList');
  let filtered = HOSPITALS.filter(h => {
    if (activeFilter === 'all') return true;
    if (activeFilter === 'TSC') return h.cert === 'TSC' || h.cert === 'TCC';
    return h.cert === activeFilter;
  });

  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  if (searchTerm) {
    filtered = filtered.filter(h =>
      h.name.toLowerCase().includes(searchTerm) ||
      h.short_name.toLowerCase().includes(searchTerm) ||
      h.city.toLowerCase().includes(searchTerm) ||
      h.affiliation.toLowerCase().includes(searchTerm)
    );
  }

  // Sort
  filtered.sort((a, b) => {
    if (activeSortKey === 'name') return a.name.localeCompare(b.name);
    return (b[activeSortKey] || 0) - (a[activeSortKey] || 0);
  });

  // Update marker visibility
  HOSPITALS.forEach((h, i) => {
    const visible = filtered.includes(h);
    if (markers[i]) {
      if (visible) markers[i].addTo(map);
      else map.removeLayer(markers[i]);
    }
  });

  list.innerHTML = filtered.map((h, rank) => {
    const idx = HOSPITALS.indexOf(h);
    const isSelected = selectedHospital === idx;
    const growthClass = h.yoy_growth > 0 ? 'positive' : 'negative';
    return `
      <div class="hospital-card${isSelected ? ' selected' : ''}" onclick="selectHospital(${idx})" data-idx="${idx}">
        <div class="card-header">
          <div class="card-rank">${rank + 1}</div>
          <div class="card-name">${h.name}</div>
          <div class="card-badges">
            <span class="badge badge-cert" style="background:${getCertColor(h.cert)}">${h.cert || 'â€”'}</span>
            <span class="badge badge-tier">T${h.tier}</span>
          </div>
        </div>
        <div class="card-meta">
          <span>${fmt(h.beds)} beds</span>
          <span>${fmt(h.strokes_yr)} strokes/yr</span>
          <span>${h.affiliation}</span>
        </div>
        <div style="display:flex;align-items:center;">
          <div class="card-nts">
            <div class="card-nts-item"><span class="card-nts-label">NTS 25: </span><span class="card-nts-value">${fmtMoney(h.nts_2025)}</span></div>
            <div class="card-nts-item"><span class="card-nts-label">YTD 26: </span><span class="card-nts-value">${fmtMoney(h.nts_2026_ytd)}</span></div>
          </div>
          <div class="card-growth ${growthClass}" style="margin-left:auto;">${h.yoy_growth > 0 ? 'â†‘' : 'â†“'} ${Math.abs(h.yoy_growth)}%</div>
        </div>
      </div>`;
  }).join('');
}

function selectHospital(idx) {
  selectedHospital = idx;
  const h = HOSPITALS[idx];
  renderCards();
  map.setView([h.lat, h.lng], Math.max(map.getZoom(), 10));
  if (markers[idx]) markers[idx].fire('click');
}

// â”€â”€ Account Drawer â”€â”€
function openDrawer(idx) {
  closeCalendar();
  const h = HOSPITALS[idx];
  selectedHospital = idx;
  document.getElementById('drawerTitle').textContent = h.short_name;

  const tpsColor = getTpsColor(h.tps_segment);
  const certColor = getCertColor(h.cert);

  // Business plan based on segment
  const plans = {
    HIGH: {
      title: 'Invest & Grow',
      items: [
        'Schedule weekly touchpoints with neuro IR and stroke teams',
        'Coordinate product evaluation trials for new devices',
        'Host quarterly clinical education events (grand rounds, case reviews)',
        'Develop joint clinical protocols with department heads',
        'Track utilization metrics and expand product portfolio',
        'Engage fellowship programs with training partnerships'
      ]
    },
    MID: {
      title: 'Develop & Build',
      items: [
        'Increase visit cadence to twice monthly',
        'Identify clinical champions and engage key decision-makers',
        'Conduct product in-services with nursing and tech staff',
        'Present clinical data and outcomes studies',
        'Target competitive conversion opportunities',
        'Build relationships with VAC and supply chain contacts'
      ]
    },
    LOW: {
      title: 'Monitor & Nurture',
      items: [
        'Maintain monthly check-in cadence',
        'Monitor for program growth or leadership changes',
        'Provide responsive clinical support as needed',
        'Track competitive landscape and market shifts',
        'Assess quarterly for segment reclassification',
        'Maintain basic product awareness and availability'
      ]
    }
  };
  const plan = plans[h.tps_segment];

  // Prevalence bars (scale to max in territory)
  const maxLvo = Math.max(...HOSPITALS.map(x => x.lvo_rate || 0)) || 1;
  const maxCsdh = Math.max(...HOSPITALS.map(x => x.csdh_mma_rate || 0)) || 1;
  const maxHem = Math.max(...HOSPITALS.map(x => x.hemorrhagic_rate || 0)) || 1;

  const cadenceMap = { HIGH: 'Weekly', MID: 'Twice/Month', LOW: 'Monthly' };

  document.getElementById('drawerBody').innerHTML = `
    <!-- Hospital Profile -->
    <div class="drawer-section">
      <div class="drawer-section-title">Hospital Profile</div>
      <div class="detail-grid">
        <div class="detail-item"><div class="detail-label">Full Name</div><div class="detail-value" style="font-size:12px;">${h.name}</div></div>
        <div class="detail-item"><div class="detail-label">Certification</div><div class="detail-value"><span class="badge badge-cert" style="background:${certColor}">${h.cert || 'None'}</span>${h.cert_body ? ' <span style="font-size:10px;color:#94a3b8;">'+h.cert_body+'</span>' : ''}</div></div>
        <div class="detail-item"><div class="detail-label">Licensed Beds</div><div class="detail-value">${fmt(h.beds)}</div></div>
        <div class="detail-item"><div class="detail-label">Strokes/Year</div><div class="detail-value">${fmt(h.strokes_yr)}</div></div>
        <div class="detail-item"><div class="detail-label">Affiliation</div><div class="detail-value" style="font-size:12px;">${h.affiliation}</div></div>
        <div class="detail-item"><div class="detail-label">GPO</div><div class="detail-value" style="font-size:12px;">${h.gpo}</div></div>
        <div class="detail-item"><div class="detail-label">Phone</div><div class="detail-value" style="font-size:12px;">${h.phone}</div></div>
        <div class="detail-item"><div class="detail-label">IR Phone</div><div class="detail-value" style="font-size:12px;">${h.ir_phone || 'â€”'}</div></div>
        <div class="detail-item"><div class="detail-label">Address</div><div class="detail-value" style="font-size:11px;">${h.address}</div></div>
        <div class="detail-item"><div class="detail-label">County</div><div class="detail-value" style="font-size:12px;">${h.county}</div></div>
      </div>
    </div>

    <!-- Programs -->
    <div class="drawer-section">
      <div class="drawer-section-title">Programs</div>
      <div class="detail-grid">
        <div class="detail-item"><div class="detail-label">Neurosurgery Fellowship</div><div class="detail-value">${h.nsg_fellowship ? 'âœ“ Yes' : 'âœ— No'}</div></div>
        <div class="detail-item"><div class="detail-label">Neuro IR Fellowship</div><div class="detail-value">${h.nir_fellowship ? 'âœ“ Yes' : 'âœ— No'}</div></div>
      </div>
    </div>

    <!-- TPS Score -->
    <div class="drawer-section">
      <div class="drawer-section-title">Territory Priority Score</div>
      <div class="tps-gauge-container">
        <div class="tps-gauge" style="background: conic-gradient(${tpsColor} ${h.tps_score * 3.6}deg, #e2e8f0 0);">
          <div style="width:48px;height:48px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;">
            <span class="tps-gauge-value" style="color:${tpsColor}">${h.tps_score}</span>
          </div>
        </div>
        <div class="tps-gauge-info">
          <div class="tps-segment-badge" style="background:${tpsColor}">${h.tps_segment}</div>
          <div class="tps-strategy">${h.tps_strategy}</div>
          <div style="font-size:11px;color:#94a3b8;margin-top:2px;">Tier ${h.tier} Â· ${cadenceMap[h.tps_segment]} cadence</div>
        </div>
      </div>
    </div>

    <!-- Catchment Demographics -->
    ${h.catchment > 0 ? `
    <div class="drawer-section">
      <div class="drawer-section-title">Catchment Demographics</div>
      <div class="detail-grid" style="margin-bottom:12px;">
        <div class="detail-item"><div class="detail-label">Population</div><div class="detail-value">${fmt(h.catchment)}</div></div>
        <div class="detail-item"><div class="detail-label">Median Age</div><div class="detail-value">${h.median_age || 'â€”'}</div></div>
        <div class="detail-item"><div class="detail-label">Life Expectancy</div><div class="detail-value">${h.life_expectancy || 'â€”'}</div></div>
      </div>
      <div class="drawer-section-title" style="font-size:10px;">Stroke Prevalence Estimates</div>
      <div class="prev-bar-container">
        <div class="prev-bar-label"><span class="prev-bar-name">LVO (24/100k)</span><span class="prev-bar-val">${fmt(h.lvo_rate)}/yr</span></div>
        <div class="prev-bar"><div class="prev-bar-fill" style="width:${Math.round(h.lvo_rate / maxLvo * 100)}%;background:var(--jnj-red);"></div></div>
      </div>
      <div class="prev-bar-container">
        <div class="prev-bar-label"><span class="prev-bar-name">cSDH/MMA (17.3/100k)</span><span class="prev-bar-val">${fmt(h.csdh_mma_rate)}/yr</span></div>
        <div class="prev-bar"><div class="prev-bar-fill" style="width:${Math.round(h.csdh_mma_rate / maxCsdh * 100)}%;background:var(--jnj-blue);"></div></div>
      </div>
      <div class="prev-bar-container">
        <div class="prev-bar-label"><span class="prev-bar-name">Hemorrhagic (12/100k)</span><span class="prev-bar-val">${fmt(h.hemorrhagic_rate)}/yr</span></div>
        <div class="prev-bar"><div class="prev-bar-fill" style="width:${Math.round(h.hemorrhagic_rate / maxHem * 100)}%;background:#7C3AED;"></div></div>
      </div>
    </div>` : ''}

    <!-- Sales Performance -->
    <div class="drawer-section">
      <div class="drawer-section-title">Sales Performance</div>
      <div class="detail-grid">
        <div class="detail-item"><div class="detail-label">NTS 2025</div><div class="detail-value">${fmtMoney(h.nts_2025)}</div></div>
        <div class="detail-item"><div class="detail-label">NTS 2026 YTD</div><div class="detail-value">${fmtMoney(h.nts_2026_ytd)}</div></div>
        <div class="detail-item"><div class="detail-label">2026 Annualized</div><div class="detail-value">${fmtMoney(h.nts_2026_annualized)}</div></div>
        <div class="detail-item"><div class="detail-label">YoY Growth</div><div class="detail-value" style="color:${h.yoy_growth > 0 ? '#059669' : '#dc2626'}">${h.yoy_growth > 0 ? 'â†‘' : 'â†“'} ${Math.abs(h.yoy_growth)}%</div></div>
      </div>
      ${h.comment ? `<div style="margin-top:8px;padding:8px;background:#fffbeb;border-radius:6px;font-size:11px;color:#92400e;">ðŸ’¡ ${h.comment}</div>` : ''}
    </div>

    <!-- Business Plan -->
    <div class="drawer-section">
      <div class="drawer-section-title">Business Plan</div>
      <div class="biz-plan">
        <div class="biz-plan-title" style="color:${tpsColor}">Strategy: ${plan.title}</div>
        <ul class="biz-plan-items">
          ${plan.items.map(item => `<li>${item}</li>`).join('')}
        </ul>
      </div>
    </div>

    <!-- Travel & Logistics -->
    <div class="drawer-section">
      <div class="drawer-section-title">Travel & Logistics</div>
      <div class="detail-grid">
        <div class="detail-item"><div class="detail-label">Closest Team Member</div><div class="detail-value" style="font-size:12px;">${h.closest_team_member}</div></div>
        <div class="detail-item"><div class="detail-label">Distance</div><div class="detail-value">${h.travel_miles} mi</div></div>
        <div class="detail-item"><div class="detail-label">Drive Time</div><div class="detail-value">${h.travel_time_min} min</div></div>
        <div class="detail-item"><div class="detail-label">Recommended Cadence</div><div class="detail-value">${cadenceMap[h.tps_segment]}</div></div>
      </div>
    </div>
  `;

  document.getElementById('accountDrawer').classList.add('open');
  renderCards();
  showToast(`Viewing ${h.short_name}`);
}

function closeDrawer() {
  document.getElementById('accountDrawer').classList.remove('open');
  selectedHospital = null;
  renderCards();
}

// â”€â”€ Calendar Panel â”€â”€
function openCalendar() {
  closeDrawer();
  const months = [
    { name: 'March 2026', weeks: 4, startWeek: 1 },
    { name: 'April 2026', weeks: 4, startWeek: 5 },
    { name: 'May 2026', weeks: 5, startWeek: 9 },
    { name: 'June 2026', weeks: 4, startWeek: 14 },
    { name: 'July 2026', weeks: 5, startWeek: 18 },
    { name: 'August 2026', weeks: 4, startWeek: 23 }
  ];

  const deptColors = {
    'Physician Lab': 'var(--dept-physician)',
    'Stroke Coord': 'var(--dept-stroke)',
    'Education Coord': 'var(--dept-education)',
    'Buying/VAC': 'var(--dept-buying)'
  };

  const cadenceWeeks = { HIGH: 1, MID: 2, LOW: 4 };

  let html = `
    <div class="cadence-legend">
      <div class="cadence-legend-item"><div class="cal-dept-dot" style="background:var(--dept-physician)"></div>Physician Lab</div>
      <div class="cadence-legend-item"><div class="cal-dept-dot" style="background:var(--dept-stroke)"></div>Stroke Coord</div>
      <div class="cadence-legend-item"><div class="cal-dept-dot" style="background:var(--dept-education)"></div>Education Coord</div>
      <div class="cadence-legend-item"><div class="cal-dept-dot" style="background:var(--dept-buying)"></div>Buying/VAC</div>
    </div>`;

  months.forEach(month => {
    html += `<div class="cal-month"><div class="cal-month-title">${month.name}</div>`;
    for (let w = 0; w < month.weeks; w++) {
      const weekNum = month.startWeek + w;
      html += `<div class="cal-week"><div class="cal-week-label">Wk ${weekNum}</div><div class="cal-week-entries">`;

      HOSPITALS.forEach(h => {
        const cadence = cadenceWeeks[h.tps_segment];
        if ((weekNum - 1) % cadence === 0) {
          // Determine which departments to visit
          const depts = ['Physician Lab'];
          if (weekNum % 2 === 0) depts.push('Stroke Coord');
          if (weekNum % 3 === 0) depts.push('Education Coord');
          if (weekNum % 4 === 0) depts.push('Buying/VAC');

          const dots = depts.map(d => `<div class="cal-dept-dot" style="background:${deptColors[d]}" title="${d}"></div>`).join('');
          html += `<div class="cal-entry" onclick="openDrawer(${HOSPITALS.indexOf(h)})" style="cursor:pointer;" title="${h.short_name}: ${depts.join(', ')}">${dots}<span>${h.short_name.length > 14 ? h.short_name.substring(0,12)+'â€¦' : h.short_name}</span></div>`;
        }
      });

      html += `</div></div>`;
    }
    html += `</div>`;
  });

  document.getElementById('calendarBody').innerHTML = html;
  document.getElementById('calendarPanel').classList.add('open');
  showToast('Cadence calendar opened');
}

function closeCalendar() {
  document.getElementById('calendarPanel').classList.remove('open');
}

// â”€â”€ Fit All â”€â”€
function fitAll() {
  const bounds = L.latLngBounds(HOSPITALS.map(h => [h.lat, h.lng]));
  map.fitBounds(bounds, { padding: [40, 40] });
  showToast('Map fitted to all markers');
}

// â”€â”€ Event Listeners â”€â”€
document.getElementById('drawerClose').addEventListener('click', closeDrawer);
document.getElementById('calendarClose').addEventListener('click', closeCalendar);
document.getElementById('btnFitAll').addEventListener('click', fitAll);
document.getElementById('btnCalendar').addEventListener('click', () => {
  if (document.getElementById('calendarPanel').classList.contains('open')) {
    closeCalendar();
  } else {
    openCalendar();
  }
});
document.getElementById('btnZoomIn').addEventListener('click', () => map.zoomIn());
document.getElementById('btnZoomOut').addEventListener('click', () => map.zoomOut());

// Search
document.getElementById('searchInput').addEventListener('input', renderCards);

// Filters
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.filter;
    renderCards();
  });
});

// Sort
document.getElementById('sortSelect').addEventListener('change', e => {
  activeSortKey = e.target.value;
  renderCards();
});

// â”€â”€ Initialize â”€â”€
createMarkers();
renderCards();

// Close drawer/calendar on Escape
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeDrawer(); closeCalendar(); }
});
</script>
</body>
</html>
